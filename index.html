<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>SNG's Funky 3D Hustle Board</title>

Â  Â  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
Â  Â  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>

Â  Â  <script src="https://cdn.tailwindcss.com"></script>

Â  Â  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

Â  Â  <link rel="preconnect" href="https://fonts.googleapis.com">
Â  Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@700;800&display=swap" rel="stylesheet">

Â  Â  <link rel="manifest" href="manifest.json"> <meta name="apple-mobile-web-app-capable" content="yes">
Â  Â  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
Â  Â  <meta name="apple-mobile-web-app-title" content="SNG Board">
Â  Â  <link rel="apple-touch-icon" href="icon-192.png"> <meta name="theme-color" content="#f97316">

Â  Â  <style>
Â  Â  Â  Â  /* --- CSS Styles --- */
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  /* Color variables */
Â  Â  Â  Â  Â  Â  --column-bg: rgba(17, 24, 39, 0.75); --column-header-text: #f1f5f9;
Â  Â  Â  Â  Â  Â  --task-bg: #ffffff; --task-text: #1f2937;
Â  Â  Â  Â  Â  Â  --idea-task-bg: #e2e8f0; --idea-task-text: #334155;
Â  Â  Â  Â  Â  Â  --accent-todo: #f59e0b; --accent-inprogress: #eab308; --accent-done: #22c55e;
Â  Â  Â  Â  Â  Â  --button-primary-bg: #dc2626; --button-primary-hover: #b91c1c;
Â  Â  Â  Â  Â  Â  --button-secondary-bg: #16a34a; --button-secondary-hover: #15803d;
Â  Â  Â  Â  Â  Â  --button-cancel-bg: #64748b; --button-cancel-hover: #475569;
Â  Â  Â  Â  Â  Â  --quote-bg: rgba(255, 255, 255, 0.1); --quote-border: rgba(255, 255, 255, 0.3); --quote-text: #f8fafc;
Â  Â  Â  Â  Â  Â  --summary-bg: rgba(30, 41, 59, 0.8); --summary-header: #facc15; --summary-text: #cbd5e1; --summary-strong: #fde047;
Â  Â  Â  Â  Â  Â  --idea-box-bg: rgba(51, 65, 85, 0.8);
Â  Â  Â  Â  Â  Â  --modal-bg: rgba(17, 24, 39, 0.9); --modal-content-bg: #1f2937;
Â  Â  Â  Â  Â  Â  --progress-bar-bg: #e5e7eb; /* gray-200 */
Â  Â  Â  Â  Â  Â  --progress-bar-fill: var(--accent-inprogress); /* Use in-progress accent */
Â  Â  Â  Â  Â  Â  --timer-text-color: #4b5563; /* gray-600 */
Â  Â  Â  Â  Â  Â  --timer-text-expired-color: #dc2626; /* red-600 */
Â  Â  Â  Â  }

Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  Â  Â  /* Consider adding a fallback background color or using a local image */
Â  Â  Â  Â  Â  Â  background-image: url('https://raw.githubusercontent.com/sniting/sng-hustle-board./main/ChatGPT%20Image%20Apr%2030%2C%202025%20at%2007_19_36%20PM.png');
Â  Â  Â  Â  Â  Â  background-size: cover; background-position: center center; background-repeat: no-repeat; background-attachment: fixed;
Â  Â  Â  Â  Â  Â  background-color: #374151; /* Fallback color */
Â  Â  Â  Â  Â  Â  padding: 2rem 1rem 5rem 1rem; color: var(--column-header-text);
Â  Â  Â  Â  Â  Â  perspective: 1800px; overflow-x: hidden; min-height: 100vh;
Â  Â  Â  Â  }
Â  Â  Â  Â  h1, h2, h3 { font-family: 'Poppins', sans-serif; font-weight: 800; letter-spacing: 0.02em; }
Â  Â  Â  Â  #main-content-wrapper { max-width: 1200px; margin: 0 auto; }
Â  Â  Â  Â  #main-title { color: #ffffff; text-shadow: 2px 2px 4px rgba(0,0,0,0.6); animation: pulse-glow 3s infinite alternate; }
Â  Â  Â  Â  #subtitle { color: #f1f5f9; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
Â  Â  Â  Â  @keyframes pulse-glow { from { text-shadow: 2px 2px 4px rgba(0,0,0,0.5), 0 0 5px rgba(255,255,255,0.3); } to { text-shadow: 2px 2px 6px rgba(0,0,0,0.6), 0 0 15px rgba(255,255,255,0.5); } }

Â  Â  Â  Â  /* Kanban Column Styling */
Â  Â  Â  Â  .kanban-column {
Â  Â  Â  Â  Â  Â  min-height: 350px; background-color: var(--column-bg); backdrop-filter: blur(12px);
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 0.75rem; padding: 1.25rem;
Â  Â  Â  Â  Â  Â  transition: all 0.35s cubic-bezier(0.25, 0.8, 0.25, 1); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25);
Â  Â  Â  Â  Â  Â  transform: rotateX(2deg) rotateY(-1deg); display: flex; flex-direction: column;
Â  Â  Â  Â  }
Â  Â  Â  Â  .kanban-column:hover { transform: rotateX(0deg) rotateY(0deg) scale(1.03) translateZ(20px); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.35); }
Â  Â  Â  Â  .kanban-column h2 {
Â  Â  Â  Â  Â  Â  color: var(--column-header-text); text-transform: uppercase; font-weight: 700; display: flex;
Â  Â  Â  Â  Â  Â  align-items: center; justify-content: center; gap: 0.6rem; border-bottom: 2px solid rgba(255, 255, 255, 0.2);
Â  Â  Â  Â  Â  Â  padding-bottom: 0.75rem; margin-bottom: 1.25rem; flex-shrink: 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  .tasks-container { flex-grow: 1; overflow-y: auto; min-height: 100px; padding-top: 5px; }

Â  Â  Â  Â  /* Task Card Styling (Daily Tasks) */
Â  Â  Â  Â  .kanban-task {
Â  Â  Â  Â  Â  Â  background-color: var(--task-bg); color: var(--task-text); border-radius: 0.5rem;
Â  Â  Â  Â  Â  Â  padding: 0.8rem 1.1rem; margin-bottom: 1rem; cursor: grab; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  Â  Â  transition: all 0.25s ease-in-out; word-break: break-word; position: relative;
Â  Â  Â  Â  Â  Â  border-left: 5px solid var(--accent-todo);
Â  Â  Â  Â  }
Â  Â  Â  Â  #inprogress .kanban-task { border-left-color: var(--accent-inprogress); }
Â  Â  Â  Â  #done .kanban-task { border-left-color: var(--accent-done); }

Â  Â  Â  Â  .task-content-display {}
Â  Â  Â  Â  .task-time-info { font-size: 0.8rem; color: #475569; margin-top: 0.4rem; display: block; font-weight: 600; }
Â  Â  Â  Â  .task-time-info .duration { color: #57534e; margin-left: 0.5rem; font-weight: 500; }
Â  Â  Â  Â  .task-completion-date { font-size: 0.75rem; color: #64748b; margin-top: 0.25rem; display: block; }

Â  Â  Â  Â  /* In Progress Timer/Progress Bar Styles */
Â  Â  Â  Â  .task-progress-container { margin-top: 0.75rem; height: 16px; display: flex; align-items: center; gap: 0.5rem; }
Â  Â  Â  Â  .progress-bar { flex-grow: 1; height: 8px; background-color: var(--progress-bar-bg); border-radius: 4px; overflow: hidden; }
Â  Â  Â  Â  .progress-bar-fill { height: 100%; width: 0%; background-color: var(--progress-bar-fill); border-radius: 4px; transition: width 0.5s ease-out; }
Â  Â  Â  Â  .remaining-time { font-size: 0.75rem; font-weight: 500; color: var(--timer-text-color); white-space: nowrap; flex-shrink: 0; }
Â  Â  Â  Â  .remaining-time.expired { color: var(--timer-text-expired-color); font-weight: 700; }

Â  Â  Â  Â  .kanban-task:active:not(.editing) { cursor: grabbing; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15); transform: scale(1.03); }
Â  Â  Â  Â  .dragging { opacity: 0.5; transform: rotate(5deg) scale(1.08) skew(-5deg, -2deg); }
Â  Â  Â  Â  .idea-task.dragging { background-color: #a7f3d0; border: 1px dashed #059669; }
Â  Â  Â  Â  .drag-over { background-color: rgba(70, 88, 116, 0.8); transform: scale(1.01); }

Â  Â  Â  Â  /* Confetti Canvas Styling */
Â  Â  Â  Â  #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }

Â  Â  Â  Â  /* Time/Date/Quote Display Styling */
Â  Â  Â  Â  #time-date-display, #selected-date-display, #motivational-quote { background-color: rgba(30, 41, 59, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); padding: 0.8rem 1.2rem; border-radius: 0.6rem; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); text-align: center; margin-bottom: 1.5rem; max-width: 550px; margin-left: auto; margin-right: auto; color: #f1f5f9; font-weight: 600; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); transition: all 0.3s ease-out; }
Â  Â  Â  Â  #time-date-display:hover, #selected-date-display:hover, #motivational-quote:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); }
Â  Â  Â  Â  #selected-date-display { background-color: rgba(51, 65, 85, 0.7); color: #ffffff; font-weight: 700; margin-top: 0.5rem; border-color: rgba(255, 255, 255, 0.3); }
Â  Â  Â  Â  #motivational-quote { background-color: rgba(17, 24, 39, 0.65); border: 1px solid var(--quote-border); color: var(--quote-text); padding: 1rem 1.2rem; font-size: 1rem; font-weight: 500; font-style: normal; text-shadow: 1px 1px 2px rgba(0,0,0,0.4); margin-bottom: 2rem; }

Â  Â  Â  Â  /* Date Selector Styling */
Â  Â  Â  Â  #date-selector-container { text-align: center; margin-bottom: 1.5rem; }
Â  Â  Â  Â  #date-selector-container label { margin-right: 0.5rem; font-weight: 700; color: #f1f5f9; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
Â  Â  Â  Â  #date-selector { padding: 0.6rem 0.8rem; border: 1px solid rgba(255,255,255,0.3); border-radius: 0.5rem; box-shadow: inset 0 1px 3px 0 rgba(0,0,0,0.1); cursor: pointer; background-color: rgba(30, 41, 59, 0.7); color: #ffffff; font-weight: 500; }

Â  Â  Â  Â  /* Add Task Form Container Styling */
Â  Â  Â  Â  Â #add-task-form-container { background-color: rgba(30, 41, 59, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); padding: 1.75rem; border-radius: 0.75rem; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25); transition: all 0.35s cubic-bezier(0.25, 0.8, 0.25, 1); transform: rotateX(1deg) rotateY(1deg); margin-bottom: 2.5rem; }
Â  Â  Â  Â  Â #add-task-form-container:hover { transform: rotateX(0deg) rotateY(0deg) scale(1.02) translateZ(15px); box-shadow: 0 12px 25px rgba(0, 0, 0, 0.3); }
Â  Â  Â  Â  #add-task-form { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; align-items: end; }
Â  Â  Â  Â  #add-task-form > div:nth-child(1) { grid-column: span 2; }
Â  Â  Â  Â  #add-task-form > div:nth-child(4) { grid-column: span 2; margin-top: 0.5rem; }
Â  Â  Â  Â  @media (min-width: 768px) { #add-task-form { grid-template-columns: minmax(150px, 3fr) 1fr 1fr auto; gap: 1rem; } #add-task-form > div:nth-child(1) { grid-column: auto; } #add-task-form > div:nth-child(4) { grid-column: auto; margin-top: 0; } }
Â  Â  Â  Â  #add-task-form label { display: block; font-size: 0.9rem; font-weight: 600; color: #cbd5e1; margin-bottom: 0.4rem; }
Â  Â  Â  Â  #add-task-form input[type="text"], #add-task-form input[type="time"] { width: 100%; border: 1px solid #475569; border-radius: 0.5rem; padding: 0.6rem 0.9rem; box-shadow: inset 0 1px 3px 0 rgba(0,0,0,0.1); font-size: 0.9rem; background-color: #1e293b; color: #f1f5f9; }
Â  Â  Â  Â  #add-task-form button { background-color: var(--button-primary-bg); color: white; font-weight: 700; padding: 0.6rem 1.5rem; border-radius: 0.5rem; transition: all 0.2s ease-in-out; box-shadow: 0 3px 6px rgba(0,0,0,0.15); border: none; cursor: pointer; text-transform: uppercase; }
Â  Â  Â  Â  #add-task-form button:hover { background-color: var(--button-primary-hover); transform: translateY(-2px) scale(1.02); box-shadow: 0 5px 10px rgba(0,0,0,0.2); }

Â  Â  Â  Â  /* Idea Box Styling */
Â  Â  Â  Â  #idea-box-container { background-color: var(--idea-box-bg); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 0.75rem; padding: 1.5rem; margin-top: 2.5rem; margin-bottom: 2.5rem; max-width: 6xl; margin-left: auto; margin-right: auto; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2); }
Â  Â  Â  Â  #idea-box-container h3 { color: #e0f2fe; text-align: center; margin-bottom: 1rem; font-weight: 700; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
Â  Â  Â  Â  #add-idea-form { display: flex; gap: 0.75rem; margin-bottom: 1.25rem; }
Â  Â  Â  Â  #idea-task-input { flex-grow: 1; border: 1px solid #475569; border-radius: 0.5rem; padding: 0.6rem 0.9rem; box-shadow: inset 0 1px 3px 0 rgba(0,0,0,0.1); font-size: 0.9rem; background-color: #1e293b; color: #f1f5f9; }
Â  Â  Â  Â  #add-idea-task-btn { background-color: var(--button-secondary-bg); color: white; font-weight: 600; padding: 0.6rem 1.2rem; border-radius: 0.5rem; transition: all 0.2s ease-in-out; box-shadow: 0 2px 5px rgba(0,0,0,0.15); border: none; cursor: pointer; white-space: nowrap; }
Â  Â  Â  Â  #add-idea-task-btn:hover { background-color: var(--button-secondary-hover); transform: translateY(-1px) scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
Â  Â  Â  Â  #idea-task-list { max-height: 250px; overflow-y: auto; padding-right: 5px; }
Â  Â  Â  Â  .idea-task { background-color: var(--idea-task-bg); color: var(--idea-task-text); border-radius: 0.375rem; padding: 0.6rem 0.9rem; margin-bottom: 0.75rem; cursor: grab; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08); transition: all 0.2s ease-in-out; word-break: break-word; position: relative; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #60a5fa; }
Â  Â  Â  Â  Â .idea-task span { flex-grow: 1; margin-right: 0.5rem; }
Â  Â  Â  Â  .idea-task:active { cursor: grabbing; }
Â  Â  Â  Â  .delete-idea-task-btn { background: none; border: none; color: #ef4444; font-size: 1.1rem; line-height: 1; cursor: pointer; padding: 0.1rem 0.2rem; opacity: 0.5; transition: all 0.2s ease; flex-shrink: 0; }
Â  Â  Â  Â  .idea-task:hover .delete-idea-task-btn { opacity: 1; }
Â  Â  Â  Â  .delete-idea-task-btn:hover { transform: scale(1.2); color: #b91c1c; }

Â  Â  Â  Â  /* Daily Summary Styling */
Â  Â  Â  Â  #daily-summary { background-color: var(--summary-bg); border: 1px solid rgba(255, 255, 255, 0.15); padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); margin-top: 2.5rem; max-width: 6xl; margin-left: auto; margin-right: auto; }
Â  Â  Â  Â  #daily-summary h3 { color: var(--summary-header); font-weight: 700; margin-bottom: 0.75rem; }
Â  Â  Â  Â  #daily-summary p { color: var(--summary-text); font-size: 0.95rem; line-height: 1.6; }
Â  Â  Â  Â  #daily-summary strong { font-weight: 700; color: var(--summary-strong); }
Â  Â  Â  Â  #daily-summary .motivation-suffix { display: block; margin-top: 1rem; font-style: italic; color: #93c5fd; }

Â  Â  Â  Â  /* Edit/Delete Styles (for daily tasks) */
Â  Â  Â  Â  .task-edit-form { display: flex; flex-direction: column; gap: 0.6rem; }
Â  Â  Â  Â  .task-edit-form input[type="text"], .task-edit-form input[type="time"] { width: 100%; border: 1px solid #94a3b8; border-radius: 0.375rem; padding: 0.4rem 0.6rem; font-size: 0.875rem; background-color: #f8fafc; color: #1e293b; }
Â  Â  Â  Â  .task-edit-form .edit-time-inputs { display: flex; gap: 0.6rem; }
Â  Â  Â  Â  .task-edit-form .edit-time-inputs > div { flex-grow: 1; }
Â  Â  Â  Â  .task-edit-form .edit-buttons { display: flex; justify-content: flex-end; gap: 0.6rem; margin-top: 0.6rem; }
Â  Â  Â  Â  .task-edit-form button { padding: 0.3rem 0.7rem; border-radius: 0.375rem; font-size: 0.8rem; font-weight: 700; transition: all 0.2s ease; border: none; cursor: pointer; text-transform: uppercase; }
Â  Â  Â  Â  .edit-save-btn { background-color: var(--button-secondary-bg); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
Â  Â  Â  Â  .edit-save-btn:hover { background-color: var(--button-secondary-hover); transform: scale(1.05); box-shadow: 0 3px 6px rgba(0,0,0,0.15); }
Â  Â  Â  Â  .edit-cancel-btn { background-color: var(--button-cancel-bg); color: #1e293b; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
Â  Â  Â  Â  .edit-cancel-btn:hover { background-color: var(--button-cancel-hover); transform: scale(1.05); box-shadow: 0 3px 6px rgba(0,0,0,0.15); }
Â  Â  Â  Â  .delete-task-btn { position: absolute; top: 0.4rem; right: 0.4rem; background: none; border: none; color: #fca5a5; font-size: 1.2rem; line-height: 1; cursor: pointer; padding: 0.1rem; opacity: 0.4; transition: all 0.2s ease; }
Â  Â  Â  Â  .kanban-task:hover .delete-task-btn { opacity: 0.8; }
Â  Â  Â  Â  .delete-task-btn:hover { opacity: 1; color: #ef4444; transform: scale(1.15) rotate(10deg); }
Â  Â  Â  Â  .kanban-task.editing { cursor: default; border-left-color: var(--button-primary-bg); }

Â  Â  Â  Â  /* Highlight effect for auto-moved tasks */
Â  Â  Â  Â  .task-just-moved { background-color: rgba(250, 204, 21, 0.3); animation: highlight-fade 1.8s ease-out; }
Â  Â  Â  Â  @keyframes highlight-fade { 0% { background-color: rgba(250, 204, 21, 0.6); } 100% { background-color: var(--task-bg); } }

Â  Â  Â  Â  /* Time Prompt Modal Styling */
Â  Â  Â  Â  #time-prompt-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 10000; }
Â  Â  Â  Â  #time-prompt-modal.active { display: flex; }
Â  Â  Â  Â  .modal-content { background-color: var(--modal-content-bg); padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4); width: 90%; max-width: 400px; border: 1px solid rgba(255, 255, 255, 0.2); }
Â  Â  Â  Â  .modal-content h3 { color: #e0f2fe; text-align: center; margin-bottom: 1.5rem; font-size: 1.25rem; }
Â  Â  Â  Â  .modal-content label { display: block; font-size: 0.9rem; font-weight: 600; color: #cbd5e1; margin-bottom: 0.4rem; margin-top: 1rem; }
Â  Â  Â  Â  .modal-content input[type="time"] { width: 100%; border: 1px solid #475569; border-radius: 0.5rem; padding: 0.6rem 0.9rem; box-shadow: inset 0 1px 3px 0 rgba(0,0,0,0.1); font-size: 0.9rem; background-color: #334155; color: #f1f5f9; }
Â  Â  Â  Â  .modal-buttons { display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 2rem; }
Â  Â  Â  Â  .modal-buttons button { padding: 0.5rem 1.2rem; border-radius: 0.5rem; font-weight: 700; transition: all 0.2s ease; border: none; cursor: pointer; text-transform: uppercase; font-size: 0.9rem; }
Â  Â  Â  Â  #modal-save-btn { background-color: var(--button-secondary-bg); color: white; }
Â  Â  Â  Â  #modal-save-btn:hover { background-color: var(--button-secondary-hover); transform: scale(1.03); }
Â  Â  Â  Â  #modal-cancel-btn { background-color: var(--button-cancel-bg); color: white; }
Â  Â  Â  Â  #modal-cancel-btn:hover { background-color: var(--button-cancel-hover); transform: scale(1.03); }

Â  Â  </style>
</head>
<body class="p-4 md:p-8">

Â  Â  <div id="main-content-wrapper">

Â  Â  Â  Â  <h1 id="main-title" class="text-5xl font-extrabold text-center mb-2">SNG's Hustle Board</h1>
Â  Â  Â  Â  <p id="subtitle" class="text-center text-lg mb-6">Plan & Conquer.</p>

Â  Â  Â  Â  <div id="time-date-display" class="text-base">Loading time...</div>
Â  Â  Â  Â  <div id="motivational-quote">Loading inspiration...</div>
Â  Â  Â  Â  <div id="date-selector-container">
Â  Â  Â  Â  Â  Â  <label for="date-selector">Select Date:</label>
Â  Â  Â  Â  Â  Â  <input type="date" id="date-selector">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="selected-date-display" class="text-lg">Loading tasks for...</div>

Â  Â  Â  Â  <div class="mb-10 max-w-xl mx-auto" id="add-task-form-container">
Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold mb-5 text-center text-slate-100">Add New Hustle (Today)</h2>
Â  Â  Â  Â  Â  Â  <div id="add-task-form">
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="new-task-input">Task:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="new-task-input" placeholder="Define the next victory..." class="focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="new-task-start-time">Start:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" id="new-task-start-time" class="focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="new-task-end-time">End:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" id="new-task-end-time" class="focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="add-task-btn" class="w-full">Lock It In</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
Â  Â  Â  Â  Â  Â  <div id="todo" class="kanban-column" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl mb-5">ğŸ¯ To Do</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="tasks-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="inprogress" class="kanban-column" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl mb-5">ğŸ”¥ In Progress</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="tasks-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="done" class="kanban-column" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl mb-5">ğŸ† Done!</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="tasks-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="idea-box-container">
Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold">ğŸ’¡ Idea Box (Unscheduled Tasks)</h3>
Â  Â  Â  Â  Â  Â  <div id="add-idea-form">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="idea-task-input" placeholder="Capture a new idea..." class="focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="add-idea-task-btn">Add Idea</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="idea-task-list">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-slate-400 text-center italic">Loading ideas...</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="daily-summary" class="hidden"> <h3 class="text-xl font-bold">Daily Wins Recap!</h3>
Â  Â  Â  Â  Â  Â  <p id="summary-content">No summary available yet.</p>
Â  Â  Â  Â  </div>

Â  Â  </div> <canvas id="confetti-canvas"></canvas>

Â  Â  <div id="time-prompt-modal">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <h3>Schedule Idea Task</h3>
Â  Â  Â  Â  Â  Â  <p id="modal-task-text" class="text-slate-300 mb-4 text-center"></p> <div>
Â  Â  Â  Â  Â  Â  Â  Â  <label for="modal-start-time">Start Time:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" id="modal-start-time">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <label for="modal-end-time">End Time:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" id="modal-end-time">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="modal-buttons">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="modal-cancel-btn">Cancel</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="modal-save-btn">Save to Schedule</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <script>
Â  Â  Â  Â  // --- Firebase Configuration ---
Â  Â  Â  Â  // Using the config provided by the user for sng-hustle-board-standalone
Â  Â  Â  Â  const firebaseConfig = {
Â  Â  Â  Â  Â  apiKey: "AIzaSyBygcOaz8etf0XycZ4ILTrUkSXD-SKhFVM", // Replace with your actual API key if needed
Â  Â  Â  Â  Â  authDomain: "sng-hustle-board-standalone.firebaseapp.com",
Â  Â  Â  Â  Â  projectId: "sng-hustle-board-standalone",
Â  Â  Â  Â  Â  storageBucket: "sng-hustle-board-standalone.appspot.com",
Â  Â  Â  Â  Â  messagingSenderId: "892064086812",
Â  Â  Â  Â  Â  appId: "1:892064086812:web:4f0aeec9a6bd24c92958d9"
Â  Â  Â  Â  };
Â  Â  Â  Â  // --- End Firebase Configuration ---


Â  Â  Â  Â  // --- Initialize Firebase ---
Â  Â  Â  Â  let db;
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // Initialize Firebase App if it hasn't been initialized yet
Â  Â  Â  Â  Â  Â  if (!firebase.apps.length) {
Â  Â  Â  Â  Â  Â  Â  Â  Â firebase.initializeApp(firebaseConfig);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â firebase.app(); // if already initialized, use that app
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Get Firestore instance
Â  Â  Â  Â  Â  Â  db = firebase.firestore();
Â  Â  Â  Â  Â  Â  console.log("Firebase initialized successfully with sng-hustle-board-standalone config.");
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Firebase initialization failed:", error);
Â  Â  Â  Â  Â  Â  // Display a prominent error message on the page if initialization fails
Â  Â  Â  Â  Â  Â  const errorDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  errorDiv.textContent = "CRITICAL ERROR: Could not initialize Firebase. Check configuration and console logs.";
Â  Â  Â  Â  Â  Â  errorDiv.style.cssText = 'background-color: #b91c1c; color: white; padding: 15px; text-align: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 10000; font-weight: bold;';
Â  Â  Â  Â  Â  Â  document.body.prepend(errorDiv);
Â  Â  Â  Â  Â  Â  // Optionally disable all functionality by disabling buttons/inputs
Â  Â  Â  Â  Â  Â  // document.querySelectorAll('button, input').forEach(el => el.disabled = true);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Firestore Collection References ---
Â  Â  Â  Â  // Get references to Firestore collections only if db was initialized successfully
Â  Â  Â  Â  const hustleTasksCollection = db ? db.collection("hustle_tasks") : null; // For daily scheduled tasks
Â  Â  Â  Â  const hustleArchiveCollection = db ? db.collection("hustle_archive") : null; // For archived tasks
Â  Â  Â  Â  const hustleIdeaBoxCollection = db ? db.collection("hustle_ideaBoxTasks") : null; // For unscheduled idea tasks

Â  Â  Â  Â  // --- Constants ---
Â  Â  Â  Â  const BOSTON_TIMEZONE = 'America/New_York'; // Timezone for date/time operations
Â  Â  Â  Â  const TASK_CHECK_INTERVAL = 60000; // Check tasks every 60 seconds (1 minute)
Â  Â  Â  Â  const TIMER_UPDATE_INTERVAL = 15000; // Update in-progress timers every 15 seconds
Â  Â  Â  Â  const LAST_MINUTE_INTERVAL = 1000; // Update timers every second when less than a minute remains

Â  Â  Â  Â  // --- Motivational Quotes & Suffixes ---
Â  Â  Â  Â  const motivationalQuotes = [
Â  Â  Â  Â  Â  Â  "The mind is everything. What you think you become. - Buddha",
Â  Â  Â  Â  Â  Â  "Whether you think you can, or you think you can't â€“ you're right. - Henry Ford",
Â  Â  Â  Â  Â  Â  "The only limit to our realization of tomorrow will be our doubts of today. - Franklin D. Roosevelt",
Â  Â  Â  Â  Â  Â  "Your time is limited, so don't waste it living someone else's life. - Steve Jobs",
Â  Â  Â  Â  Â  Â  "The trouble is, you think you have time. - Buddha",
Â  Â  Â  Â  Â  Â  "Lost time is never found again. - Benjamin Franklin",
Â  Â  Â  Â  Â  Â  "Time is what we want most, but what we use worst. - William Penn",
Â  Â  Â  Â  Â  Â  "The purpose of life, after all, is to live it, to taste experience to the utmost, to reach out eagerly and without fear for newer and richer experience. - Eleanor Roosevelt",
Â  Â  Â  Â  Â  Â  "Life is not a problem to be solved, but a reality to be experienced. - Soren Kierkegaard",
Â  Â  Â  Â  Â  Â  "In the end, it's not the years in your life that count. It's the life in your years. - Abraham Lincoln",
Â  Â  Â  Â  Â  Â  "Get busy living or get busy dying. - Stephen King (from The Shawshank Redemption)",
Â  Â  Â  Â  Â  Â  "Very little is needed to make a happy life; it is all within yourself, in your way of thinking. - Marcus Aurelius",
Â  Â  Â  Â  Â  Â  "You have power over your mind â€“ not outside events. Realize this, and you will find strength. - Marcus Aurelius",
Â  Â  Â  Â  Â  Â  "The two most important days in your life are the day you are born and the day you find out why. - Mark Twain",
Â  Â  Â  Â  Â  Â  "Don't be pushed around by the fears in your mind. Be led by the dreams in your heart. - Roy T. Bennett"
Â  Â  Â  Â  ];
Â  Â  Â  Â  let currentQuoteIndex = -1; // To track the last shown quote index
Â  Â  Â  Â  const motivationalSuffixes = [
Â  Â  Â  Â  Â  Â  "Each step forward, no matter how small, builds momentum towards the happy, healthy, and abundant life you're creating. Keep going!", "Remember why you started! Every completed task is a brick laid on the foundation of your dream life â€“ full of joy, well-being, and success.", "You're not just checking boxes; you're actively crafting a future filled with health, wealth, and happiness. Celebrate the progress!", "This hustle is fueling your journey towards enjoying every moment, backed by fitness and financial freedom. Awesome work!", "Stay focused on the vision: a vibrant life filled with health, prosperity, and genuine enjoyment. Today's wins are paving the way!"
Â  Â  Â  Â  ];
Â  Â  Â  Â  let currentSuffixIndex = -1; // To track the last shown summary suffix

Â  Â  Â  Â  // --- DOM Elements ---
Â  Â  Â  Â  // Get references to frequently used DOM elements
Â  Â  Â  Â  const columns = document.querySelectorAll('.kanban-column');
Â  Â  Â  Â  const timeDateDisplay = document.getElementById('time-date-display');
Â  Â  Â  Â  const dateSelector = document.getElementById('date-selector');
Â  Â  Â  Â  const selectedDateDisplay = document.getElementById('selected-date-display');
Â  Â  Â  Â  const dailySummaryDiv = document.getElementById('daily-summary');
Â  Â  Â  Â  const summaryContentP = document.getElementById('summary-content');
Â  Â  Â  Â  const confettiCanvas = document.getElementById('confetti-canvas');
Â  Â  Â  Â  const quoteDisplay = document.getElementById('motivational-quote');
Â  Â  Â  Â  const ideaTaskInput = document.getElementById('idea-task-input');
Â  Â  Â  Â  const addIdeaTaskBtn = document.getElementById('add-idea-task-btn');
Â  Â  Â  Â  const ideaTaskList = document.getElementById('idea-task-list');
Â  Â  Â  Â  const timePromptModal = document.getElementById('time-prompt-modal');
Â  Â  Â  Â  const modalTaskText = document.getElementById('modal-task-text');
Â  Â  Â  Â  const modalStartTimeInput = document.getElementById('modal-start-time');
Â  Â  Â  Â  const modalEndTimeInput = document.getElementById('modal-end-time');
Â  Â  Â  Â  const modalSaveBtn = document.getElementById('modal-save-btn');
Â  Â  Â  Â  const modalCancelBtn = document.getElementById('modal-cancel-btn');

Â  Â  Â  Â  // --- Confetti Setup ---
Â  Â  Â  Â  let myConfetti = null;
Â  Â  Â  Â  // Initialize confetti only if the library is loaded
Â  Â  Â  Â  if (typeof confetti !== 'undefined') {
Â  Â  Â  Â  Â  Â  Â myConfetti = confetti.create(confettiCanvas, { resize: true, useWorker: true });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â console.warn("Confetti library not loaded.");
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- State Variables ---
Â  Â  Â  Â  let draggedElement = null; Â  Â  Â // Stores the element being dragged
Â  Â  Â  Â  let draggedElementType = null; Â // Stores the type ('kanban-task' or 'idea-task') of the dragged element
Â  Â  Â  Â  let currentSelectedDate = ''; Â  // Stores the currently selected date string (YYYY-MM-DD)
Â  Â  Â  Â  let taskCheckIntervalId = null; // Stores the interval ID for checking task start times
Â  Â  Â  Â  let progressTimerIntervalId = null; // Stores the interval ID for updating progress bars
Â  Â  Â  Â  let lastMinuteIntervalId = null; // Stores the interval ID for faster updates in the last minute
Â  Â  Â  Â  let ideaTaskToSchedule = null; Â // Stores idea task data when prompting for time

Â  Â  Â  Â  // --- Utility Functions ---

Â  Â  Â  Â  // Gets the current date in YYYY-MM-DD format for a given timezone
Â  Â  Â  Â  function getCurrentDateString(timeZone) {
Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  const formatter = new Intl.DateTimeFormat('en-CA', { // en-CA format is YYYY-MM-DD
Â  Â  Â  Â  Â  Â  Â  Â  year: 'numeric',
Â  Â  Â  Â  Â  Â  Â  Â  month: '2-digit',
Â  Â  Â  Â  Â  Â  Â  Â  day: '2-digit',
Â  Â  Â  Â  Â  Â  Â  Â  timeZone: timeZone
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  return formatter.format(now);
Â  Â  Â  Â  }

Â  Â  Â  Â  // Gets the current time in HH:MM (24-hour) format for a given timezone
Â  Â  Â  Â  function getCurrentTimeString(timeZone) {
Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  const formatter = new Intl.DateTimeFormat('en-GB', { // en-GB uses 24-hour format
Â  Â  Â  Â  Â  Â  Â  Â  hour: '2-digit',
Â  Â  Â  Â  Â  Â  Â  Â  minute: '2-digit',
Â  Â  Â  Â  Â  Â  Â  Â  hour12: false,
Â  Â  Â  Â  Â  Â  Â  Â  timeZone: timeZone
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  return formatter.format(now);
Â  Â  Â  Â  }

Â  Â  Â  Â  // Formats the current date and time for display (e.g., "Wednesday, April 30, 2025, 4:23 PM EDT")
Â  Â  Â  Â  function formatLiveDateTime(timeZone) {
Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  const options = {
Â  Â  Â  Â  Â  Â  Â  Â  weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
Â  Â  Â  Â  Â  Â  Â  Â  hour: 'numeric', minute: '2-digit', timeZoneName: 'short',
Â  Â  Â  Â  Â  Â  Â  Â  timeZone: timeZone
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  return now.toLocaleString('en-US', options);
Â  Â  Â  Â  }

Â  Â  Â  Â  // Formats a YYYY-MM-DD date string into a more readable format (e.g., "April 30, 2025")
Â  Â  Â  Â  function formatDisplayDate(dateString) {
Â  Â  Â  Â  Â  Â  if (!dateString || !/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return "Invalid Date";
Â  Â  Â  Â  Â  Â  const [year, month, day] = dateString.split('-');
Â  Â  Â  Â  Â  Â  // Use UTC to avoid timezone issues when creating the date object from parts
Â  Â  Â  Â  Â  Â  const date = new Date(Date.UTC(Number(year), Number(month) - 1, Number(day)));
Â  Â  Â  Â  Â  Â  const options = { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' };
Â  Â  Â  Â  Â  Â  return date.toLocaleDateString('en-US', options);
Â  Â  Â  Â  }

Â  Â  Â  Â  // Calculates the duration between two HH:MM time strings (e.g., "1h 30m")
Â  Â  Â  Â  function calculateDuration(startTime, endTime) {
Â  Â  Â  Â  Â  Â  if (!startTime || !endTime) return "";
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Create date objects on a common date to compare times
Â  Â  Â  Â  Â  Â  Â  Â  const start = new Date(`1970-01-01T${startTime}:00`);
Â  Â  Â  Â  Â  Â  Â  Â  const end = new Date(`1970-01-01T${endTime}:00`);
Â  Â  Â  Â  Â  Â  Â  Â  if (isNaN(start) || isNaN(end) || end <= start) return ""; // Invalid or end time is not after start time

Â  Â  Â  Â  Â  Â  Â  Â  let diffMillis = end - start;
Â  Â  Â  Â  Â  Â  Â  Â  const hours = Math.floor(diffMillis / (1000 * 60 * 60));
Â  Â  Â  Â  Â  Â  Â  Â  diffMillis -= hours * (1000 * 60 * 60);
Â  Â  Â  Â  Â  Â  Â  Â  const minutes = Math.floor(diffMillis / (1000 * 60));

Â  Â  Â  Â  Â  Â  Â  Â  let durationStr = "";
Â  Â  Â  Â  Â  Â  Â  Â  if (hours > 0) durationStr += `${hours}h `;
Â  Â  Â  Â  Â  Â  Â  Â  if (minutes > 0) durationStr += `${minutes}m`;
Â  Â  Â  Â  Â  Â  Â  Â  return durationStr.trim();
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error calculating duration:", e);
Â  Â  Â  Â  Â  Â  Â  Â  return ""; // Return empty string on error
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Formats an HH:MM time string into 12-hour format with AM/PM
Â  Â  Â  Â  function formatTimeTo12Hour(timeString) {
Â  Â  Â  Â  Â  Â  if (!timeString || !/^\d{2}:\d{2}$/.test(timeString)) {
Â  Â  Â  Â  Â  Â  Â  Â  return timeString; // Return original if format is invalid
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const [hours, minutes] = timeString.split(':');
Â  Â  Â  Â  Â  Â  const hourNum = parseInt(hours, 10);
Â  Â  Â  Â  Â  Â  const ampm = hourNum >= 12 ? 'PM' : 'AM';
Â  Â  Â  Â  Â  Â  let hour12 = hourNum % 12;
Â  Â  Â  Â  Â  Â  if (hour12 === 0) { // Handle midnight (00:xx) and noon (12:xx)
Â  Â  Â  Â  Â  Â  Â  Â  hour12 = 12;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return `${hour12}:${minutes} ${ampm}`;
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- Data Management Functions (Firestore) ---

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Loads tasks for a specific date from the 'hustle_tasks' collection.
Â  Â  Â  Â  Â * Includes detailed error logging.
Â  Â  Â  Â  Â * @param {string} dateString - The date in YYYY-MM-DD format.
Â  Â  Â  Â  Â * @returns {Promise<object>} A promise that resolves to an object {todo: [], inprogress: [], done: []}.
Â  Â  Â  Â  Â * @throws {Error} If Firestore is not initialized or if loading fails.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function loadTasksFromFirestore(dateString) {
Â  Â  Â  Â  Â  Â  // Check if Firestore is initialized
Â  Â  Â  Â  Â  Â  if (!db || !hustleTasksCollection) {
Â  Â  Â  Â  Â  Â  Â  Â  const errorMsg = "Firestore 'hustle_tasks' collection not initialized when loading tasks.";
Â  Â  Â  Â  Â  Â  Â  Â  console.error(errorMsg);
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(errorMsg);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  console.log(`Attempting to load daily tasks for date: ${dateString}...`);
Â  Â  Â  Â  Â  Â  // Validate the date string format
Â  Â  Â  Â  Â  Â  if (!dateString || typeof dateString !== 'string' || !/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error(`Invalid dateString provided to loadTasksFromFirestore: ${dateString}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â alert(`Internal Error: Invalid date format used (${dateString}). Cannot load tasks.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error(`Invalid dateString: ${dateString}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Get a reference to the specific date document
Â  Â  Â  Â  Â  Â  const docRef = hustleTasksCollection.doc(dateString);

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Fetching document: ${docRef.path}`);
Â  Â  Â  Â  Â  Â  Â  Â  const docSnap = await docRef.get(); // Attempt to get the document

Â  Â  Â  Â  Â  Â  Â  Â  // ******** FIX: Use docSnap.exists (property) instead of docSnap.exists() (method) ********
Â  Â  Â  Â  Â  Â  Â  Â  if (docSnap.exists) { // Check the boolean property for Compat SDK
Â  Â  Â  Â  Â  Â  Â  Â  // ***************************************************************************************
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Document found for ${dateString}. Data:`, docSnap.data());
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = docSnap.data() || {}; // Use empty object if data is null/undefined

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Validate the structure of the data, providing defaults if fields are missing/invalid
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tasks = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  todo: Array.isArray(data.todo) ? data.todo : [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  inprogress: Array.isArray(data.inprogress) ? data.inprogress : [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  done: Array.isArray(data.done) ? data.done : []
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Successfully processed tasks for ${dateString}.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return tasks;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Document doesn't exist for this date
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`No document found for ${dateString}, returning empty task lists.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { todo: [], inprogress: [], done: [] }; // Return empty structure
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  // Log detailed error information if the fetch fails
Â  Â  Â  Â  Â  Â  Â  Â  console.error(`âŒâŒâŒ ERROR loading daily tasks document for ${dateString}:`, error);
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error Code:", error.code);
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error Message:", error.message);

Â  Â  Â  Â  Â  Â  Â  Â  // Show a user-friendly alert
Â  Â  Â  Â  Â  Â  Â  Â  alert(`Failed to load tasks for ${formatDisplayDate(dateString)}. Check console for details (F12 -> Console).`);

Â  Â  Â  Â  Â  Â  Â  Â  // Re-throw the error so the calling function knows it failed
Â  Â  Â  Â  Â  Â  Â  Â  throw error;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Saves the current state of the Kanban board for a specific date to Firestore.
Â  Â  Â  Â  Â * Overwrites the existing document for that date.
Â  Â  Â  Â  Â * @param {string} dateString - The date in YYYY-MM-DD format.
Â  Â  Â  Â  Â * @param {object} tasksForDate - An object {todo: [], inprogress: [], done: []} containing task data.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function saveTasksToFirestore(dateString, tasksForDate) {
Â  Â  Â  Â  Â  Â  Â // Check if Firestore is initialized
Â  Â  Â  Â  Â  Â  Â if (!db || !hustleTasksCollection) { console.error("Firestore 'hustle_tasks' collection not initialized."); return; }
Â  Â  Â  Â  Â  Â  Â // Validate the date string format
Â  Â  Â  Â  Â  Â  Â if (!dateString || typeof dateString !== 'string' || !/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error(`Invalid dateString provided to saveTasksToFirestore: ${dateString}. Aborting save.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â alert(`Internal Error: Invalid date format used (${dateString}). Cannot save tasks.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â console.log(`Attempting to save daily tasks for ${dateString}... Data:`, tasksForDate);
Â  Â  Â  Â  Â  Â  Â // Get a reference to the specific date document
Â  Â  Â  Â  Â  Â  Â const docRef = hustleTasksCollection.doc(dateString);
Â  Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â  Â // Use set() to completely overwrite the document with the new state
Â  Â  Â  Â  Â  Â  Â  Â  Â await docRef.set(tasksForDate);
Â  Â  Â  Â  Â  Â  Â  Â  Â console.log("Daily tasks successfully saved for date:", dateString);
Â  Â  Â  Â  Â  Â  Â } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â // Log detailed error information if saving fails
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error(`âŒâŒâŒ Error saving daily tasks for ${dateString}:`, error);
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Error Code:", error.code);
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Error Message:", error.message);
Â  Â  Â  Â  Â  Â  Â  Â  Â alert(`Error saving daily tasks for ${formatDisplayDate(dateString)}. Check console for details.`);
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Loads all tasks from the 'hustle_ideaBoxTasks' collection, ordered by creation time.
Â  Â  Â  Â  Â * @returns {Promise<Array>} A promise that resolves to an array of idea task objects.
Â  Â  Â  Â  Â * @throws {Error} If Firestore is not initialized or loading fails.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function loadIdeaTasksFromFirestore() {
Â  Â  Â  Â  Â  Â  // Check if Firestore is initialized
Â  Â  Â  Â  Â  Â  if (!db || !hustleIdeaBoxCollection) { console.error("Firestore 'hustle_ideaBoxTasks' collection not initialized when loading ideas."); return []; }
Â  Â  Â  Â  Â  Â  console.log("Loading idea tasks from Firestore...");
Â  Â  Â  Â  Â  Â  const ideaTasks = [];
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Query the collection, ordering by 'createdAt' descending
Â  Â  Â  Â  Â  Â  Â  Â  const querySnapshot = await hustleIdeaBoxCollection.orderBy("createdAt", "desc").get();
Â  Â  Â  Â  Â  Â  Â  Â  // Extract data from each document
Â  Â  Â  Â  Â  Â  Â  Â  querySnapshot.forEach((doc) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ideaTasks.push({ id: doc.id, ...doc.data() }); // Include the document ID
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Loaded ${ideaTasks.length} idea tasks.`);
Â  Â  Â  Â  Â  Â  Â  Â  return ideaTasks;
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  // Log detailed error information if loading fails
Â  Â  Â  Â  Â  Â  Â  Â  console.error("âŒâŒâŒ Error getting idea tasks:", error);
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error Code:", error.code);
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error Message:", error.message);
Â  Â  Â  Â  Â  Â  Â  Â  // Show appropriate user alerts
Â  Â  Â  Â  Â  Â  Â  Â  if (error.code === 'unavailable') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Could not connect to Firestore to load ideas. Please check your internet connection.");
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Error loading ideas. Check console for details.");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  throw error; // Re-throw the error
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Adds a new task to the 'hustle_ideaBoxTasks' collection.
Â  Â  Â  Â  Â * @param {string} taskText - The text content of the idea task.
Â  Â  Â  Â  Â * @returns {Promise<string>} A promise that resolves to the new document's ID.
Â  Â  Â  Â  Â * @throws {Error} If Firestore is not initialized or adding fails.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function addIdeaTaskToFirestore(taskText) {
Â  Â  Â  Â  Â  Â  console.log("DEBUG: Inside addIdeaTaskToFirestore, text:", taskText);
Â  Â  Â  Â  Â  Â  // Check Firestore initialization
Â  Â  Â  Â  Â  Â  if (!db) { console.error("DEBUG: Firestore DB object is not available in addIdeaTaskToFirestore."); throw new Error("Database not initialized."); }
Â  Â  Â  Â  Â  Â  if (!hustleIdeaBoxCollection) { console.error("DEBUG: Firestore 'hustle_ideaBoxTasks' collection reference is not available."); throw new Error("Database collection 'hustle_ideaBoxTasks' could not be referenced."); }
Â  Â  Â  Â  Â  Â  console.log("DEBUG: hustleIdeaBoxCollection reference is valid. Type:", typeof hustleIdeaBoxCollection, " Path:", hustleIdeaBoxCollection.path);

Â  Â  Â  Â  Â  Â  console.log("DEBUG: Attempting Firestore add operation...");
Â  Â  Â  Â  Â  Â  // Data to add, including a server timestamp for creation time
Â  Â  Â  Â  Â  Â  const dataToAdd = {
Â  Â  Â  Â  Â  Â  Â  Â  text: taskText,
Â  Â  Â  Â  Â  Â  Â  Â  createdAt: firebase.firestore.FieldValue.serverTimestamp()
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  console.log("DEBUG: Data to add:", dataToAdd);

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Add the document to the collection
Â  Â  Â  Â  Â  Â  Â  Â  const docRef = await hustleIdeaBoxCollection.add(dataToAdd);
Â  Â  Â  Â  Â  Â  Â  Â  console.log("DEBUG: Firestore add operation successful (inside try). Document ID: ", docRef.id);
Â  Â  Â  Â  Â  Â  Â  Â  return docRef.id; // Return the new document ID
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  // Log detailed error information if adding fails
Â  Â  Â  Â  Â  Â  Â  Â  console.error("DEBUG: Error during Firestore add operation (inside catch): ", error);
Â  Â  Â  Â  Â  Â  Â  Â  console.error("DEBUG: Error Code:", error.code);
Â  Â  Â  Â  Â  Â  Â  Â  console.error("DEBUG: Error Message:", error.message);
Â  Â  Â  Â  Â  Â  Â  Â  // Show appropriate user alerts based on error code
Â  Â  Â  Â  Â  Â  Â  Â  if (error.code === 'permission-denied') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(`Error saving idea task: Permission denied. Check Firestore rules for hustle_ideaBoxTasks collection.`);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(`Error saving idea task: ${error.message} (Code: ${error.code}). Check console logs.`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  throw error; // Re-throw the error
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Deletes a task from the 'hustle_ideaBoxTasks' collection.
Â  Â  Â  Â  Â * @param {string} taskId - The ID of the document to delete.
Â  Â  Â  Â  Â * @throws {Error} If Firestore is not initialized or deleting fails.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function deleteIdeaTaskFromFirestore(taskId) {
Â  Â  Â  Â  Â  Â  // Check Firestore initialization
Â  Â  Â  Â  Â  Â  if (!db || !hustleIdeaBoxCollection) { console.error("Firestore 'hustle_ideaBoxTasks' collection not initialized."); throw new Error("Database not initialized for Idea Box."); }
Â  Â  Â  Â  Â  Â  console.log("DEBUG: Attempting to delete idea task with ID:", taskId);
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Delete the document with the specified ID
Â  Â  Â  Â  Â  Â  Â  Â  await hustleIdeaBoxCollection.doc(taskId).delete();
Â  Â  Â  Â  Â  Â  Â  Â  console.log("DEBUG: Idea task deleted successfully from Firestore: ", taskId);
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  // Log detailed error information if deleting fails
Â  Â  Â  Â  Â  Â  Â  Â  console.error("DEBUG: Error deleting idea task from Firestore: ", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â // Show specific alert for permission errors
Â  Â  Â  Â  Â  Â  Â  Â  Â if (error.code === 'permission-denied') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(`Error deleting idea task: Permission denied. Check Firestore rules allow 'delete' on hustle_ideaBoxTasks.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(`Error deleting idea task: ${error.message}. Check console.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  throw error; // Re-throw the error
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- Core Application Functions ---

Â  Â  Â  Â  // Updates the time display element with the current formatted date and time
Â  Â  Â  Â  function updateTimeDisplay() {
Â  Â  Â  Â  Â  Â  if (timeDateDisplay) {
Â  Â  Â  Â  Â  Â  Â  Â  timeDateDisplay.textContent = formatLiveDateTime(BOSTON_TIMEZONE);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Clears all task elements from the Kanban board columns
Â  Â  Â  Â  function clearBoard() {
Â  Â  Â  Â  Â  Â  columns.forEach(column => {
Â  Â  Â  Â  Â  Â  Â  Â  const tc = column.querySelector('.tasks-container');
Â  Â  Â  Â  Â  Â  Â  Â  if (tc) tc.innerHTML = ''; // Remove all child elements
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // Creates the inner HTML content for a task card (text, time, completion date)
Â  Â  Â  Â  function createTaskDisplayContent(taskData) {
Â  Â  Â  Â  Â  Â  const displayWrapper = document.createElement('div');
Â  Â  Â  Â  Â  Â  displayWrapper.classList.add('task-content-display');

Â  Â  Â  Â  Â  Â  // Add task text
Â  Â  Â  Â  Â  Â  const textNode = document.createTextNode(taskData.text || 'No description');
Â  Â  Â  Â  Â  Â  displayWrapper.appendChild(textNode);

Â  Â  Â  Â  Â  Â  // Add start/end time and duration if available
Â  Â  Â  Â  Â  Â  if (taskData.startTime && taskData.endTime) {
Â  Â  Â  Â  Â  Â  Â  Â  const timeInfoSpan = document.createElement('span');
Â  Â  Â  Â  Â  Â  Â  Â  timeInfoSpan.classList.add('task-time-info');
Â  Â  Â  Â  Â  Â  Â  Â  const duration = calculateDuration(taskData.startTime, taskData.endTime);
Â  Â  Â  Â  Â  Â  Â  Â  const formattedStart = formatTimeTo12Hour(taskData.startTime);
Â  Â  Â  Â  Â  Â  Â  Â  const formattedEnd = formatTimeTo12Hour(taskData.endTime);
Â  Â  Â  Â  Â  Â  Â  Â  timeInfoSpan.innerHTML = `${formattedStart} - ${formattedEnd}` + (duration ? ` <span class="duration">(${duration})</span>` : '');
Â  Â  Â  Â  Â  Â  Â  Â  displayWrapper.appendChild(timeInfoSpan);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Add completion date if available
Â  Â  Â  Â  Â  Â  if (taskData.completionDate) {
Â  Â  Â  Â  Â  Â  Â  Â  const dateSpan = document.createElement('span');
Â  Â  Â  Â  Â  Â  Â  Â  dateSpan.classList.add('task-completion-date');
Â  Â  Â  Â  Â  Â  Â  Â  dateSpan.textContent = `Completed: ${formatDisplayDate(taskData.completionDate)}`;
Â  Â  Â  Â  Â  Â  Â  Â  displayWrapper.appendChild(dateSpan);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return displayWrapper;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Creates a Kanban task element (div) from task data
Â  Â  Â  Â  function createTaskElement(taskData, columnId) {
Â  Â  Â  Â  Â  Â  // Generate a unique ID for the element if not provided (e.g., from Firestore)
Â  Â  Â  Â  Â  Â  const taskId = taskData.firestoreId || `task-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
Â  Â  Â  Â  Â  Â  const { text, startTime, endTime, completionDate } = taskData;

Â  Â  Â  Â  Â  Â  // Create the main task div
Â  Â  Â  Â  Â  Â  const task = document.createElement('div');
Â  Â  Â  Â  Â  Â  task.classList.add('kanban-task');
Â  Â  Â  Â  Â  Â  task.setAttribute('draggable', 'true'); // Make it draggable
Â  Â  Â  Â  Â  Â  task.id = taskId;

Â  Â  Â  Â  Â  Â  // Store task data in dataset attributes for easy access
Â  Â  Â  Â  Â  Â  task.dataset.type = 'kanban-task';
Â  Â  Â  Â  Â  Â  task.dataset.text = text || '';
Â  Â  Â  Â  Â  Â  if (startTime) task.dataset.startTime = startTime;
Â  Â  Â  Â  Â  Â  if (endTime) task.dataset.endTime = endTime;
Â  Â  Â  Â  Â  Â  if (completionDate) task.dataset.completionDate = completionDate;

Â  Â  Â  Â  Â  Â  // Create and append the display content (text, time, etc.)
Â  Â  Â  Â  Â  Â  const displayContent = createTaskDisplayContent(taskData);
Â  Â  Â  Â  Â  Â  task.appendChild(displayContent);

Â  Â  Â  Â  Â  Â  // Add progress bar elements if the task is in the 'inprogress' column and has times
Â  Â  Â  Â  Â  Â  if (columnId === 'inprogress' && startTime && endTime) {
Â  Â  Â  Â  Â  Â  Â  Â  task.appendChild(createProgressElements());
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Create and append the delete button
Â  Â  Â  Â  Â  Â  const deleteBtn = document.createElement('button');
Â  Â  Â  Â  Â  Â  deleteBtn.classList.add('delete-task-btn');
Â  Â  Â  Â  Â  Â  deleteBtn.innerHTML = '&times;'; // Use 'Ã—' symbol
Â  Â  Â  Â  Â  Â  deleteBtn.setAttribute('aria-label', 'Delete task');
Â  Â  Â  Â  Â  Â  // Add click handler for deletion
Â  Â  Â  Â  Â  Â  deleteBtn.onclick = async (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  event.stopPropagation(); // Prevent triggering edit mode on button click
Â  Â  Â  Â  Â  Â  Â  Â  if (confirm(`Delete task: "${task.dataset.text}"?`)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  task.remove(); // Remove element immediately from UI
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await saveCurrentBoardState(); // Save the updated board state to Firestore
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  task.appendChild(deleteBtn);

Â  Â  Â  Â  Â  Â  // Add event listeners for drag-and-drop and double-click editing
Â  Â  Â  Â  Â  Â  task.addEventListener('dragstart', handleDragStart);
Â  Â  Â  Â  Â  Â  task.addEventListener('dragend', handleDragEnd);
Â  Â  Â  Â  Â  Â  task.addEventListener('dblclick', (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  // Don't enter edit mode if the delete button was clicked
Â  Â  Â  Â  Â  Â  Â  Â  if (event.target === deleteBtn || deleteBtn.contains(event.target)) return;
Â  Â  Â  Â  Â  Â  Â  Â  enterEditMode(task);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  return task;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Creates the HTML elements for the progress bar and remaining time display
Â  Â  Â  Â  function createProgressElements() {
Â  Â  Â  Â  Â  Â  const container = document.createElement('div');
Â  Â  Â  Â  Â  Â  container.classList.add('task-progress-container');

Â  Â  Â  Â  Â  Â  const progressBar = document.createElement('div');
Â  Â  Â  Â  Â  Â  progressBar.classList.add('progress-bar');
Â  Â  Â  Â  Â  Â  const progressBarFill = document.createElement('div');
Â  Â  Â  Â  Â  Â  progressBarFill.classList.add('progress-bar-fill');
Â  Â  Â  Â  Â  Â  progressBar.appendChild(progressBarFill);

Â  Â  Â  Â  Â  Â  const remainingTimeSpan = document.createElement('span');
Â  Â  Â  Â  Â  Â  remainingTimeSpan.classList.add('remaining-time');
Â  Â  Â  Â  Â  Â  remainingTimeSpan.textContent = 'Calculating...'; // Initial text

Â  Â  Â  Â  Â  Â  container.appendChild(progressBar);
Â  Â  Â  Â  Â  Â  container.appendChild(remainingTimeSpan);
Â  Â  Â  Â  Â  Â  return container;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Idea Box Functions ---

Â  Â  Â  Â  // Creates an Idea Box task element (div) from idea task data
Â  Â  Â  Â  function createIdeaTaskElement(ideaTaskData) {
Â  Â  Â  Â  Â  Â  const { id, text } = ideaTaskData; // Destructure ID and text from data

Â  Â  Â  Â  Â  Â  // Create the main task div
Â  Â  Â  Â  Â  Â  const task = document.createElement('div');
Â  Â  Â  Â  Â  Â  task.classList.add('idea-task');
Â  Â  Â  Â  Â  Â  task.setAttribute('draggable', 'true'); // Make it draggable
Â  Â  Â  Â  Â  Â  task.id = `idea-${id}`; // Use Firestore ID for the element ID
Â  Â  Â  Â  Â  Â  task.dataset.id = id; // Store Firestore ID in dataset
Â  Â  Â  Â  Â  Â  task.dataset.text = text;
Â  Â  Â  Â  Â  Â  task.dataset.type = 'idea-task'; // Mark type for drag/drop logic

Â  Â  Â  Â  Â  Â  // Add task text
Â  Â  Â  Â  Â  Â  const textSpan = document.createElement('span');
Â  Â  Â  Â  Â  Â  textSpan.textContent = text;
Â  Â  Â  Â  Â  Â  task.appendChild(textSpan);

Â  Â  Â  Â  Â  Â  // Create and append the delete button
Â  Â  Â  Â  Â  Â  const deleteBtn = document.createElement('button');
Â  Â  Â  Â  Â  Â  deleteBtn.classList.add('delete-idea-task-btn');
Â  Â  Â  Â  Â  Â  deleteBtn.innerHTML = '&times;';
Â  Â  Â  Â  Â  Â  deleteBtn.setAttribute('aria-label', 'Delete idea task');

Â  Â  Â  Â  Â  Â  // Add click handler for deletion
Â  Â  Â  Â  Â  Â  deleteBtn.addEventListener('click', async (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  event.stopPropagation();
Â  Â  Â  Â  Â  Â  Â  Â  // Retrieve the ID directly from the element's dataset when clicked
Â  Â  Â  Â  Â  Â  Â  Â  const taskIdToDelete = task.dataset.id;
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`DEBUG: Delete button clicked for idea ID: ${taskIdToDelete}, Text: "${task.dataset.text}"`);

Â  Â  Â  Â  Â  Â  Â  Â  if (confirm(`Are you sure you want to delete idea: "${task.dataset.text}"?`)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  deleteBtn.disabled = true; // Disable button during deletion
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`DEBUG: Calling deleteIdeaTaskFromFirestore for ID: ${taskIdToDelete}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await deleteIdeaTaskFromFirestore(taskIdToDelete); // Call Firestore delete
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`DEBUG: Firestore delete successful for ID: ${taskIdToDelete}. Removing element.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  task.remove(); // Remove element from UI on success
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  deleteBtn.disabled = false; // Re-enable button on error
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("DEBUG: Failed to delete idea task (error caught in click handler):", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Alert is handled within deleteIdeaTaskFromFirestore
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("DEBUG: Delete confirmation cancelled.");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  task.appendChild(deleteBtn);

Â  Â  Â  Â  Â  Â  // Add drag-and-drop listeners
Â  Â  Â  Â  Â  Â  task.addEventListener('dragstart', handleDragStart);
Â  Â  Â  Â  Â  Â  task.addEventListener('dragend', handleDragEnd);
Â  Â  Â  Â  Â  Â  return task;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Loads and displays tasks from the Idea Box collection in the UI
Â  Â  Â  Â  async function displayIdeaTasks() {
Â  Â  Â  Â  Â  Â  if (!ideaTaskList) return; // Ensure the list element exists
Â  Â  Â  Â  Â  Â  ideaTaskList.innerHTML = '<p class="text-slate-400 text-center italic">Loading ideas...</p>'; // Show loading indicator
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const ideaTasks = await loadIdeaTasksFromFirestore(); // Fetch tasks
Â  Â  Â  Â  Â  Â  Â  Â  ideaTaskList.innerHTML = ''; // Clear loading/previous list

Â  Â  Â  Â  Â  Â  Â  Â  if (ideaTasks.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Show message if no ideas exist
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ideaTaskList.innerHTML = '<p class="text-slate-400 text-center italic">No ideas captured yet. Add some!</p>';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Create and append elements for each idea task
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ideaTasks.forEach(taskData => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const taskElement = createIdeaTaskElement(taskData);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ideaTaskList.appendChild(taskElement);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Error displaying idea tasks:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â // Show error message in the UI if loading failed
Â  Â  Â  Â  Â  Â  Â  Â  Â if (ideaTaskList.innerHTML.includes('Loading')) { // Avoid duplicate error messages
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ideaTaskList.innerHTML = '<p class="text-red-400 text-center italic">Error loading ideas. Please check connection/console.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Handles adding a new task to the Idea Box
Â  Â  Â  Â  async function addIdeaTask() {
Â  Â  Â  Â  Â  Â  console.log("DEBUG: addIdeaTask called");
Â  Â  Â  Â  Â  Â  if (!ideaTaskInput || !addIdeaTaskBtn) { console.error("DEBUG: Idea task input or button not found."); return; }
Â  Â  Â  Â  Â  Â  const taskText = ideaTaskInput.value.trim(); // Get and trim input value
Â  Â  Â  Â  Â  Â  if (taskText === '') { // Validate input
Â  Â  Â  Â  Â  Â  Â  Â  alert('Please enter an idea description.');
Â  Â  Â  Â  Â  Â  Â  Â  ideaTaskInput.focus();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  console.log("DEBUG: Disabling button, text:", taskText);
Â  Â  Â  Â  Â  Â  addIdeaTaskBtn.disabled = true; addIdeaTaskBtn.textContent = 'Adding...'; // Provide user feedback

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  console.log("DEBUG: Calling addIdeaTaskToFirestore...");
Â  Â  Â  Â  Â  Â  Â  Â  const newId = await addIdeaTaskToFirestore(taskText); // Add to Firestore
Â  Â  Â  Â  Â  Â  Â  Â  console.log("DEBUG: Back from addIdeaTaskToFirestore. ID:", newId);

Â  Â  Â  Â  Â  Â  Â  Â  // Create data object including the new ID received from Firestore
Â  Â  Â  Â  Â  Â  Â  Â  const newTaskData = { id: newId, text: taskText, createdAt: new Date() }; // Use actual ID
Â  Â  Â  Â  Â  Â  Â  Â  const newTaskElement = createIdeaTaskElement(newTaskData); // Create UI element

Â  Â  Â  Â  Â  Â  Â  Â  // Update UI
Â  Â  Â  Â  Â  Â  Â  Â  const placeholder = ideaTaskList.querySelector('p'); // Find placeholder text
Â  Â  Â  Â  Â  Â  Â  Â  if (placeholder) placeholder.remove(); // Remove placeholder if it exists
Â  Â  Â  Â  Â  Â  Â  Â  ideaTaskList.prepend(newTaskElement); // Add new task to the top of the list
Â  Â  Â  Â  Â  Â  Â  Â  ideaTaskInput.value = ''; // Clear input field ONLY on success
Â  Â  Â  Â  Â  Â  Â  Â  console.log("DEBUG: Successfully added idea to UI:", taskText);

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  // Error handling (alert is shown within addIdeaTaskToFirestore)
Â  Â  Â  Â  Â  Â  Â  Â  console.error("DEBUG: Error caught in addIdeaTask's catch block:", error);
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  // Always re-enable the button and reset its text
Â  Â  Â  Â  Â  Â  Â  Â  console.log("DEBUG: Executing finally block in addIdeaTask");
Â  Â  Â  Â  Â  Â  Â  Â  addIdeaTaskBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  addIdeaTaskBtn.textContent = 'Add Idea';
Â  Â  Â  Â  Â  Â  Â  Â  ideaTaskInput.focus(); // Set focus back to input
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- Edit Mode Functions (Daily Tasks) ---

Â  Â  Â  Â  // Switches a Kanban task element into edit mode
Â  Â  Â  Â  function enterEditMode(taskElement) {
Â  Â  Â  Â  Â  Â  if (taskElement.classList.contains('editing')) return; // Already in edit mode

Â  Â  Â  Â  Â  Â  taskElement.classList.add('editing');
Â  Â  Â  Â  Â  Â  taskElement.setAttribute('draggable', 'false'); // Disable dragging while editing

Â  Â  Â  Â  Â  Â  // Hide the normal display content and progress bar
Â  Â  Â  Â  Â  Â  const displayContent = taskElement.querySelector('.task-content-display');
Â  Â  Â  Â  Â  Â  if (displayContent) displayContent.style.display = 'none';
Â  Â  Â  Â  Â  Â  const progressContainer = taskElement.querySelector('.task-progress-container');
Â  Â  Â  Â  Â  Â  if (progressContainer) progressContainer.style.display = 'none';

Â  Â  Â  Â  Â  Â  // Create the edit form elements
Â  Â  Â  Â  Â  Â  const editForm = document.createElement('div');
Â  Â  Â  Â  Â  Â  editForm.classList.add('task-edit-form');

Â  Â  Â  Â  Â  Â  const textInput = document.createElement('input');
Â  Â  Â  Â  Â  Â  textInput.type = 'text';
Â  Â  Â  Â  Â  Â  textInput.value = taskElement.dataset.text || '';
Â  Â  Â  Â  Â  Â  textInput.placeholder = 'Task description';

Â  Â  Â  Â  Â  Â  const timeInputsDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  timeInputsDiv.classList.add('edit-time-inputs');
Â  Â  Â  Â  Â  Â  const startTimeDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  const startTimeInput = document.createElement('input');
Â  Â  Â  Â  Â  Â  startTimeInput.type = 'time';
Â  Â  Â  Â  Â  Â  startTimeInput.value = taskElement.dataset.startTime || '';
Â  Â  Â  Â  Â  Â  startTimeDiv.appendChild(startTimeInput);
Â  Â  Â  Â  Â  Â  const endTimeDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  const endTimeInput = document.createElement('input');
Â  Â  Â  Â  Â  Â  endTimeInput.type = 'time';
Â  Â  Â  Â  Â  Â  endTimeInput.value = taskElement.dataset.endTime || '';
Â  Â  Â  Â  Â  Â  endTimeDiv.appendChild(endTimeInput);
Â  Â  Â  Â  Â  Â  timeInputsDiv.appendChild(startTimeDiv);
Â  Â  Â  Â  Â  Â  timeInputsDiv.appendChild(endTimeDiv);

Â  Â  Â  Â  Â  Â  const buttonsDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  buttonsDiv.classList.add('edit-buttons');
Â  Â  Â  Â  Â  Â  const saveBtn = document.createElement('button');
Â  Â  Â  Â  Â  Â  saveBtn.textContent = 'Save';
Â  Â  Â  Â  Â  Â  saveBtn.classList.add('edit-save-btn');
Â  Â  Â  Â  Â  Â  saveBtn.onclick = () => saveEdit(taskElement, textInput, startTimeInput, endTimeInput); // Pass elements to save function
Â  Â  Â  Â  Â  Â  const cancelBtn = document.createElement('button');
Â  Â  Â  Â  Â  Â  cancelBtn.textContent = 'Cancel';
Â  Â  Â  Â  Â  Â  cancelBtn.classList.add('edit-cancel-btn');
Â  Â  Â  Â  Â  Â  cancelBtn.onclick = () => cancelEdit(taskElement);
Â  Â  Â  Â  Â  Â  buttonsDiv.appendChild(saveBtn);
Â  Â  Â  Â  Â  Â  buttonsDiv.appendChild(cancelBtn);

Â  Â  Â  Â  Â  Â  // Append form elements to the task element
Â  Â  Â  Â  Â  Â  editForm.appendChild(textInput);
Â  Â  Â  Â  Â  Â  editForm.appendChild(timeInputsDiv);
Â  Â  Â  Â  Â  Â  editForm.appendChild(buttonsDiv);
Â  Â  Â  Â  Â  Â  taskElement.appendChild(editForm);

Â  Â  Â  Â  Â  Â  textInput.focus(); // Focus the text input
Â  Â  Â  Â  }

Â  Â  Â  Â  // Exits edit mode for a Kanban task element
Â  Â  Â  Â  function exitEditMode(taskElement) {
Â  Â  Â  Â  Â  Â  const editForm = taskElement.querySelector('.task-edit-form');
Â  Â  Â  Â  Â  Â  if (editForm) editForm.remove(); // Remove the edit form

Â  Â  Â  Â  Â  Â  // Restore visibility of normal display content and progress bar
Â  Â  Â  Â  Â  Â  const displayContent = taskElement.querySelector('.task-content-display');
Â  Â  Â  Â  Â  Â  if (displayContent) displayContent.style.display = '';
Â  Â  Â  Â  Â  Â  const progressContainer = taskElement.querySelector('.task-progress-container');
Â  Â  Â  Â  Â  Â  if (progressContainer) progressContainer.style.display = 'flex'; // Use flex for progress bar layout

Â  Â  Â  Â  Â  Â  taskElement.classList.remove('editing');
Â  Â  Â  Â  Â  Â  taskElement.setAttribute('draggable', 'true'); // Re-enable dragging
Â  Â  Â  Â  }

Â  Â  Â  Â  // Saves the edited task data and updates the UI and Firestore
Â  Â  Â  Â  async function saveEdit(taskElement, textInput, startTimeInput, endTimeInput) {
Â  Â  Â  Â  Â  Â  const newText = textInput.value.trim();
Â  Â  Â  Â  Â  Â  const newStartTime = startTimeInput.value;
Â  Â  Â  Â  Â  Â  const newEndTime = endTimeInput.value;

Â  Â  Â  Â  Â  Â  // --- Input Validation ---
Â  Â  Â  Â  Â  Â  if (newText === '') {
Â  Â  Â  Â  Â  Â  Â  Â  alert('Task description cannot be empty.');
Â  Â  Â  Â  Â  Â  Â  Â  textInput.focus();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Basic time format validation (HH:MM)
Â  Â  Â  Â  Â  Â  if (!/^\d{2}:\d{2}$/.test(newStartTime)) {
Â  Â  Â  Â  Â  Â  Â  Â  alert('Please enter a valid start time (HH:MM).');
Â  Â  Â  Â  Â  Â  Â  Â  startTimeInput.focus();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (!/^\d{2}:\d{2}$/.test(newEndTime)) {
Â  Â  Â  Â  Â  Â  Â  Â  alert('Please enter a valid end time (HH:MM).');
Â  Â  Â  Â  Â  Â  Â  Â  endTimeInput.focus();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Ensure end time is after start time
Â  Â  Â  Â  Â  Â  if (newStartTime >= newEndTime) {
Â  Â  Â  Â  Â  Â  Â  Â  alert('End time must be after start time.');
Â  Â  Â  Â  Â  Â  Â  Â  endTimeInput.focus();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // --- End Validation ---

Â  Â  Â  Â  Â  Â  // Update the task element's dataset attributes
Â  Â  Â  Â  Â  Â  taskElement.dataset.text = newText;
Â  Â  Â  Â  Â  Â  taskElement.dataset.startTime = newStartTime;
Â  Â  Â  Â  Â  Â  taskElement.dataset.endTime = newEndTime;
Â  Â  Â  Â  Â  Â  // Preserve completion date if it exists
Â  Â  Â  Â  Â  Â  const completionDate = taskElement.dataset.completionDate || null;

Â  Â  Â  Â  Â  Â  // Update the display content within the task element
Â  Â  Â  Â  Â  Â  const displayContent = taskElement.querySelector('.task-content-display');
Â  Â  Â  Â  Â  Â  if (displayContent) {
Â  Â  Â  Â  Â  Â  Â  Â  // Clear existing content
Â  Â  Â  Â  Â  Â  Â  Â  while (displayContent.firstChild) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayContent.removeChild(displayContent.firstChild);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // Create and append new content based on updated data
Â  Â  Â  Â  Â  Â  Â  Â  const updatedDisplayData = { text: newText, startTime: newStartTime, endTime: newEndTime, completionDate: completionDate };
Â  Â  Â  Â  Â  Â  Â  Â  const newDisplay = createTaskDisplayContent(updatedDisplayData);
Â  Â  Â  Â  Â  Â  Â  Â  while (newDisplay.firstChild) { // Move nodes from newDisplay to displayContent
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayContent.appendChild(newDisplay.firstChild);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // If the task is in the 'inprogress' column, update its timer immediately
Â  Â  Â  Â  Â  Â  if (taskElement.closest('#inprogress')) {
Â  Â  Â  Â  Â  Â  Â  Â  updateSingleTaskTimer(taskElement);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  exitEditMode(taskElement); // Exit the editing UI
Â  Â  Â  Â  Â  Â  await saveCurrentBoardState(); // Save the entire board state to Firestore
Â  Â  Â  Â  Â  Â  console.log("Task edited and saved:", taskElement.id);
Â  Â  Â  Â  }

Â  Â  Â  Â  // Cancels the edit operation and restores the task element's original state
Â  Â  Â  Â  function cancelEdit(taskElement) {
Â  Â  Â  Â  Â  Â  exitEditMode(taskElement);
Â  Â  Â  Â  Â  Â  console.log("Task edit cancelled:", taskElement.id);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Daily Task Board Functions ---

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Loads and displays tasks for a specific date on the Kanban board.
Â  Â  Â  Â  Â * @param {string} dateString - The date in YYYY-MM-DD format.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function displayTasksForDate(dateString) {
Â  Â  Â  Â  Â  Â  // Check Firestore initialization
Â  Â  Â  Â  Â  Â  if (!db) {
Â  Â  Â  Â  Â  Â  Â  Â  selectedDateDisplay.textContent = "Database not connected.";
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  currentSelectedDate = dateString; // Update the global state
Â  Â  Â  Â  Â  Â  const formattedDate = formatDisplayDate(dateString); // Format for display
Â  Â  Â  Â  Â  Â  selectedDateDisplay.textContent = `Loading tasks for ${formattedDate}...`; // Update UI
Â  Â  Â  Â  Â  Â  if (dateSelector) dateSelector.value = dateString; // Sync date picker input
Â  Â  Â  Â  Â  Â  clearBoard(); // Clear existing tasks from the board

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Load tasks using the enhanced loadTasksFromFirestore function
Â  Â  Â  Â  Â  Â  Â  Â  const tasksForDay = await loadTasksFromFirestore(dateString);

Â  Â  Â  Â  Â  Â  Â  Â  // Update display message only on successful load
Â  Â  Â  Â  Â  Â  Â  Â  selectedDateDisplay.textContent = `Showing tasks for: ${formattedDate}`;

Â  Â  Â  Â  Â  Â  Â  Â  // Populate Kanban columns with loaded tasks
Â  Â  Â  Â  Â  Â  Â  Â  Object.keys(tasksForDay).forEach(columnId => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const columnElement = document.getElementById(columnId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tasksContainer = columnElement?.querySelector('.tasks-container');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (tasksContainer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // tasksContainer.innerHTML = ''; // Optional: Ensure container is empty
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tasksForDay[columnId].forEach(taskData => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const taskElement = createTaskElement(taskData, columnId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tasksContainer.appendChild(taskElement);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`Tasks container not found in column "${columnId}".`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  checkAndMoveTasks(); // Check if tasks need to be moved based on current time
Â  Â  Â  Â  Â  Â  Â  Â  updateInProgressTimers(); // Initialize/update progress timers

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  // Error is logged in detail within loadTasksFromFirestore
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error caught by displayTasksForDate:", error);
Â  Â  Â  Â  Â  Â  Â  Â  // Update display to indicate failure (alert was already shown)
Â  Â  Â  Â  Â  Â  Â  Â  selectedDateDisplay.textContent = `Showing tasks for: ${formattedDate} (Load Failed)`;
Â  Â  Â  Â  Â  Â  Â  Â  // Avoid running checks/timers if the load failed
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Gathers the current state of all tasks on the board and saves it to Firestore
Â  Â  Â  Â  Â * for the currently selected date.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function saveCurrentBoardState() {
Â  Â  Â  Â  Â  Â  Â // Check Firestore initialization
Â  Â  Â  Â  Â  Â  Â if (!db || !hustleTasksCollection) { console.error("Firestore 'hustle_tasks' collection not initialized."); return; }
Â  Â  Â  Â  Â  Â  Â // Check if a date is selected
Â  Â  Â  Â  Â  Â  Â if (!currentSelectedDate) { console.log("No date selected, cannot save daily state."); return; }

Â  Â  Â  Â  Â  Â  Â // Prepare the data structure to save
Â  Â  Â  Â  Â  Â  Â const tasksForCurrentDate = { todo: [], inprogress: [], done: [] };

Â  Â  Â  Â  Â  Â  Â // Iterate through each column
Â  Â  Â  Â  Â  Â  Â columns.forEach(column => {
Â  Â  Â  Â  Â  Â  Â  Â  Â const columnId = column.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â const tasksContainer = column.querySelector('.tasks-container');
Â  Â  Â  Â  Â  Â  Â  Â  Â // Check if the column ID is valid and the container exists
Â  Â  Â  Â  Â  Â  Â  Â  Â if (tasksForCurrentDate.hasOwnProperty(columnId) && tasksContainer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Iterate through each task element in the container
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â tasksContainer.querySelectorAll('.kanban-task').forEach(task => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Skip tasks currently being edited
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (task.classList.contains('editing')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.warn("Skipping save for task in edit mode:", task.id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Extract task data from dataset attributes
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const taskData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â text: task.dataset.text || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â startTime: task.dataset.startTime || null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â endTime: task.dataset.endTime || null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Retrieve completion date carefully, ensuring 'null' string isn't saved
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â completionDate: task.dataset.completionDate && task.dataset.completionDate !== 'null' ? task.dataset.completionDate : null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Only save tasks that have text content
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (taskData.text) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â tasksForCurrentDate[columnId].push(taskData);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.warn("Skipping saving daily task with no text:", task.id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  Â } else if (!tasksContainer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.warn(`Tasks container not found in column "${columnId}" during save.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â });

Â  Â  Â  Â  Â  Â  Â // Call the function to save the structured data to Firestore
Â  Â  Â  Â  Â  Â  Â await saveTasksToFirestore(currentSelectedDate, tasksForCurrentDate);
Â  Â  Â  Â  Â }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Handles adding a new daily task from the form to the 'To Do' column.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function addTask() {
Â  Â  Â  Â  Â  Â  // Check Firestore initialization
Â  Â  Â  Â  Â  Â  if (!db || !hustleTasksCollection) { alert("Database not connected. Cannot add task."); return; }

Â  Â  Â  Â  Â  Â  // Get references to form elements
Â  Â  Â  Â  Â  Â  const taskInput = document.getElementById('new-task-input');
Â  Â  Â  Â  Â  Â  const startTimeInput = document.getElementById('new-task-start-time');
Â  Â  Â  Â  Â  Â  const endTimeInput = document.getElementById('new-task-end-time');
Â  Â  Â  Â  Â  Â  const todoColumn = document.getElementById('todo');
Â  Â  Â  Â  Â  Â  const todoTasksContainer = todoColumn?.querySelector('.tasks-container');

Â  Â  Â  Â  Â  Â  // Ensure all elements are found
Â  Â  Â  Â  Â  Â  if (!taskInput || !startTimeInput || !endTimeInput || !todoTasksContainer) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error: Daily task form/column elements not found.");
Â  Â  Â  Â  Â  Â  Â  Â  alert("Error: Could not find necessary form elements.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Get and validate form input values
Â  Â  Â  Â  Â  Â  const taskText = taskInput.value.trim();
Â  Â  Â  Â  Â  Â  const startTime = startTimeInput.value;
Â  Â  Â  Â  Â  Â  const endTime = endTimeInput.value;

Â  Â  Â  Â  Â  Â  if (taskText === '') { alert('Please enter a task description.'); taskInput.focus(); return; }
Â  Â  Â  Â  Â  Â  if (!startTime) { alert('Please enter a start time.'); startTimeInput.focus(); return; }
Â  Â  Â  Â  Â  Â  if (!endTime) { alert('Please enter an end time.'); endTimeInput.focus(); return; }
Â  Â  Â  Â  Â  Â  if (startTime >= endTime) { alert('End time must be after start time.'); endTimeInput.focus(); return; }
Â  Â  Â  Â  Â  Â  if (!currentSelectedDate) { alert('Please select a date first.'); return; } // Ensure a date is selected

Â  Â  Â  Â  Â  Â  // Create task data object
Â  Â  Â  Â  Â  Â  const newTaskData = { text: taskText, startTime: startTime, endTime: endTime, completionDate: null };
Â  Â  Â  Â  Â  Â  // Create the task element for the UI
Â  Â  Â  Â  Â  Â  const newTaskElement = createTaskElement(newTaskData, 'todo');

Â  Â  Â  Â  Â  Â  if (newTaskElement) {
Â  Â  Â  Â  Â  Â  Â  Â  // Add the new task element to the 'To Do' column
Â  Â  Â  Â  Â  Â  Â  Â  todoTasksContainer.appendChild(newTaskElement);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error creating daily task element.");
Â  Â  Â  Â  Â  Â  Â  Â  alert("Error: Could not create the task visually.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Clear the form fields
Â  Â  Â  Â  Â  Â  taskInput.value = ''; startTimeInput.value = ''; endTimeInput.value = '';

Â  Â  Â  Â  Â  Â  // Save the updated board state to Firestore
Â  Â  Â  Â  Â  Â  await saveCurrentBoardState();
Â  Â  Â  Â  Â  Â  console.log(`Daily task added locally for "${taskText}", saving board state.`);

Â  Â  Â  Â  Â  Â  checkAndMoveTasks(); // Check if the new task should be moved immediately
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- Drag and Drop Event Handlers ---

Â  Â  Â  Â  // Called when dragging of a task starts
Â  Â  Â  Â  function handleDragStart(event) {
Â  Â  Â  Â  Â  Â  // Prevent dragging if the task is being edited
Â  Â  Â  Â  Â  Â  if (event.target.classList.contains('kanban-task') && event.target.classList.contains('editing')) {
Â  Â  Â  Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  draggedElement = event.target; // Store the element being dragged
Â  Â  Â  Â  Â  Â  draggedElementType = event.target.dataset.type; // Store its type
Â  Â  Â  Â  Â  Â  event.dataTransfer.setData('text/plain', event.target.id); // Set data for the drag operation
Â  Â  Â  Â  Â  Â  event.dataTransfer.effectAllowed = "move"; // Indicate that moving is allowed
Â  Â  Â  Â  Â  Â  // Add dragging class slightly later for visual feedback
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  if (draggedElement) draggedElement.classList.add('dragging');
Â  Â  Â  Â  Â  Â  }, 0);
Â  Â  Â  Â  Â  Â  console.log(`Drag Start: ${draggedElementType} - ${draggedElement.id}`);
Â  Â  Â  Â  }

Â  Â  Â  Â  // Called when dragging of a task ends (successfully or cancelled)
Â  Â  Â  Â  function handleDragEnd() {
Â  Â  Â  Â  Â  Â  if (draggedElement) {
Â  Â  Â  Â  Â  Â  Â  Â  draggedElement.classList.remove('dragging'); // Remove dragging style
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Drag End: ${draggedElementType} - ${draggedElement.id}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Clear state variables
Â  Â  Â  Â  Â  Â  draggedElement = null;
Â  Â  Â  Â  Â  Â  draggedElementType = null;
Â  Â  Â  Â  Â  Â  // Remove drag-over styling from all columns
Â  Â  Â  Â  Â  Â  columns.forEach(col => col.classList.remove('drag-over'));
Â  Â  Â  Â  }

Â  Â  Â  Â  // Called frequently as an element is dragged over a potential drop target
Â  Â  Â  Â  function handleDragOver(event) {
Â  Â  Â  Â  Â  Â  event.preventDefault(); // Necessary to allow dropping
Â  Â  Â  Â  Â  Â  const targetColumn = event.target.closest('.kanban-column');
Â  Â  Â  Â  Â  Â  const targetTask = event.target.closest('.kanban-task, .idea-task');

Â  Â  Â  Â  Â  Â  // Prevent dropping onto a task that is being edited
Â  Â  Â  Â  Â  Â  if (targetTask && targetTask.classList.contains('editing')) {
Â  Â  Â  Â  Â  Â  Â  Â  event.dataTransfer.dropEffect = "none"; // Indicate dropping is not allowed
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Prevent dropping idea tasks onto 'In Progress' or 'Done' columns
Â  Â  Â  Â  Â  Â  if (draggedElementType === 'idea-task' && targetColumn && (targetColumn.id === 'inprogress' || targetColumn.id === 'done')) {
Â  Â  Â  Â  Â  Â  Â  Â  event.dataTransfer.dropEffect = "none";
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  event.dataTransfer.dropEffect = "move"; // Indicate dropping is allowed

Â  Â  Â  Â  Â  Â  // Add visual feedback to the column being dragged over
Â  Â  Â  Â  Â  Â  if (targetColumn && !targetColumn.classList.contains('drag-over')) {
Â  Â  Â  Â  Â  Â  Â  Â  columns.forEach(col => col.classList.remove('drag-over')); // Remove from others
Â  Â  Â  Â  Â  Â  Â  Â  targetColumn.classList.add('drag-over'); // Add to current target
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Called when a dragged element leaves a potential drop target
Â  Â  Â  Â  function handleDragLeave(event) {
Â  Â  Â  Â  Â  Â  const targetColumn = event.target.closest('.kanban-column');
Â  Â  Â  Â  Â  Â  // Remove drag-over style if the mouse leaves the column area
Â  Â  Â  Â  Â  Â  if (targetColumn && !targetColumn.contains(event.relatedTarget)) {
Â  Â  Â  Â  Â  Â  Â  Â  targetColumn.classList.remove('drag-over');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Called when a dragged element is dropped onto a valid drop target
Â  Â  Â  Â  async function handleDrop(event) {
Â  Â  Â  Â  Â  Â  event.preventDefault(); // Prevent default browser behavior
Â  Â  Â  Â  Â  Â  const targetColumn = event.target.closest('.kanban-column');
Â  Â  Â  Â  Â  Â  const targetTasksContainer = targetColumn?.querySelector('.tasks-container');
Â  Â  Â  Â  Â  Â  const targetElement = event.target.closest('.kanban-task, .idea-task'); // Element being dropped onto (if any)

Â  Â  Â  Â  Â  Â  targetColumn?.classList.remove('drag-over'); // Remove visual feedback

Â  Â  Â  Â  Â  Â  // --- Validation checks ---
Â  Â  Â  Â  Â  Â  if (!targetColumn || !targetTasksContainer || !draggedElement || !draggedElementType) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Drop cancelled: Invalid target or no dragged element."); return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (targetElement && targetElement.classList.contains('editing')) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Drop cancelled: Target element is being edited."); return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Prevent invalid drops (idea task to wrong column, dropping onto self)
Â  Â  Â  Â  Â  Â  if (draggedElementType === 'idea-task' && (targetColumn.id === 'inprogress' || targetColumn.id === 'done')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.warn("Drop cancelled: Idea tasks can only be dropped onto 'To Do'."); return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (draggedElement === targetElement) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.warn("Drop cancelled: Dropped onto self."); return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // --- End Validation ---

Â  Â  Â  Â  Â  Â  console.log(`Drop detected: ${draggedElementType} onto ${targetColumn.id}`);

Â  Â  Â  Â  Â  Â  // --- Handle different drop scenarios ---

Â  Â  Â  Â  Â  Â  // Scenario 1: Dropping an Idea Task onto the 'To Do' column
Â  Â  Â  Â  Â  Â  if (draggedElementType === 'idea-task' && targetColumn.id === 'todo') {
Â  Â  Â  Â  Â  Â  Â  Â  // Store idea data and show the time prompt modal
Â  Â  Â  Â  Â  Â  Â  Â  ideaTaskToSchedule = { id: draggedElement.dataset.id, text: draggedElement.dataset.text };
Â  Â  Â  Â  Â  Â  Â  Â  showTimePrompt(ideaTaskToSchedule.text);
Â  Â  Â  Â  Â  Â  Â  Â  // The original idea task element remains in the Idea Box until scheduled via modal
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Scenario 2: Dropping a Kanban Task (moving between columns or reordering)
Â  Â  Â  Â  Â  Â  else if (draggedElementType === 'kanban-task') {
Â  Â  Â  Â  Â  Â  Â  Â  const previousColumn = draggedElement.parentElement.closest('.kanban-column');
Â  Â  Â  Â  Â  Â  Â  Â  let completionDate = draggedElement.dataset.completionDate || null;

Â  Â  Â  Â  Â  Â  Â  Â  // --- Update task state based on target column ---

Â  Â  Â  Â  Â  Â  Â  Â  // Remove progress bar if moving out of 'In Progress'
Â  Â  Â  Â  Â  Â  Â  Â  if (previousColumn?.id === 'inprogress' && targetColumn.id !== 'inprogress') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const progressContainer = draggedElement.querySelector('.task-progress-container');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (progressContainer) progressContainer.remove();
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Clear completion date if moving out of 'Done'
Â  Â  Â  Â  Â  Â  Â  Â  if (targetColumn.id !== 'done') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const existingDateSpan = draggedElement.querySelector('.task-completion-date');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (existingDateSpan) existingDateSpan.remove();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  delete draggedElement.dataset.completionDate; // Remove from dataset
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completionDate = null;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Handle moving into 'Done'
Â  Â  Â  Â  Â  Â  Â  Â  if (targetColumn.id === 'done') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Set completion date if not already set
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!completionDate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completionDate = getCurrentDateString(BOSTON_TIMEZONE);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  draggedElement.dataset.completionDate = completionDate;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Update or add the completion date display
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const existingDateSpan = draggedElement.querySelector('.task-completion-date');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (existingDateSpan) existingDateSpan.remove(); // Remove old one first
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dateSpan = document.createElement('span');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dateSpan.classList.add('task-completion-date');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dateSpan.textContent = `Completed: ${formatDisplayDate(completionDate)}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Append after time info or at the end of display content
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const timeInfo = draggedElement.querySelector('.task-time-info');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const displayContent = draggedElement.querySelector('.task-content-display');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (timeInfo) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timeInfo.insertAdjacentElement('afterend', dateSpan);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (displayContent) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayContent.appendChild(dateSpan);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Trigger confetti if moving into 'Done' from another column
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (previousColumn && previousColumn.id !== 'done' && myConfetti) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  triggerConfetti();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Handle moving into 'In Progress'
Â  Â  Â  Â  Â  Â  Â  Â  if (targetColumn.id === 'inprogress' && previousColumn?.id !== 'inprogress') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Add progress elements if the task has start/end times
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (draggedElement.dataset.startTime && draggedElement.dataset.endTime) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!draggedElement.querySelector('.task-progress-container')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  draggedElement.appendChild(createProgressElements());
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateSingleTaskTimer(draggedElement); // Update timer immediately
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // --- Move the element in the DOM ---
Â  Â  Â  Â  Â  Â  Â  Â  // Insert before the target element if dropped onto another task, otherwise append to the end
Â  Â  Â  Â  Â  Â  Â  Â  if (targetElement && targetTasksContainer.contains(targetElement)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  targetTasksContainer.insertBefore(draggedElement, targetElement);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  targetTasksContainer.appendChild(draggedElement);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Save the new board state and update timers
Â  Â  Â  Â  Â  Â  Â  Â  await saveCurrentBoardState();
Â  Â  Â  Â  Â  Â  Â  Â  updateInProgressTimers();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- Time Prompt Modal Functions ---

Â  Â  Â  Â  // Shows the modal to set start/end times for a scheduled idea task
Â  Â  Â  Â  function showTimePrompt(taskText) {
Â  Â  Â  Â  Â  Â  if (!timePromptModal || !modalTaskText || !modalStartTimeInput || !modalEndTimeInput) return;
Â  Â  Â  Â  Â  Â  modalTaskText.textContent = `Scheduling: "${taskText}"`; // Display task text
Â  Â  Â  Â  Â  Â  modalStartTimeInput.value = ''; // Clear inputs
Â  Â  Â  Â  Â  Â  modalEndTimeInput.value = '';
Â  Â  Â  Â  Â  Â  timePromptModal.classList.add('active'); // Make modal visible
Â  Â  Â  Â  Â  Â  modalStartTimeInput.focus(); // Focus the start time input
Â  Â  Â  Â  }

Â  Â  Â  Â  // Hides the time prompt modal and resets state
Â  Â  Â  Â  function hideTimePrompt() {
Â  Â  Â  Â  Â  Â  if (!timePromptModal) return;
Â  Â  Â  Â  Â  Â  timePromptModal.classList.remove('active'); // Hide modal
Â  Â  Â  Â  Â  Â  ideaTaskToSchedule = null; // Clear the task data being scheduled
Â  Â  Â  Â  Â  Â  modalStartTimeInput.value = '';
Â  Â  Â  Â  Â  Â  modalEndTimeInput.value = '';
Â  Â  Â  Â  }

Â  Â  Â  Â  // Handles saving the scheduled task from the modal
Â  Â  Â  Â  async function handleModalSave() {
Â  Â  Â  Â  Â  Â  // Ensure data and elements are available
Â  Â  Â  Â  Â  Â  if (!ideaTaskToSchedule || !modalStartTimeInput || !modalEndTimeInput) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Cannot save modal: Missing task data or input elements.");
Â  Â  Â  Â  Â  Â  Â  Â  hideTimePrompt(); return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Get and validate times
Â  Â  Â  Â  Â  Â  const startTime = modalStartTimeInput.value;
Â  Â  Â  Â  Â  Â  const endTime = modalEndTimeInput.value;
Â  Â  Â  Â  Â  Â  if (!startTime) { alert('Please enter a start time.'); modalStartTimeInput.focus(); return; }
Â  Â  Â  Â  Â  Â  if (!endTime) { alert('Please enter an end time.'); modalEndTimeInput.focus(); return; }
Â  Â  Â  Â  Â  Â  if (startTime >= endTime) { alert('End time must be after start time.'); modalEndTimeInput.focus(); return; }
Â  Â  Â  Â  Â  Â  if (!currentSelectedDate) { alert('Cannot schedule task: No date selected.'); hideTimePrompt(); return; }

Â  Â  Â  Â  Â  Â  // Create data for the new Kanban task
Â  Â  Â  Â  Â  Â  const newTaskData = {
Â  Â  Â  Â  Â  Â  Â  Â  text: ideaTaskToSchedule.text,
Â  Â  Â  Â  Â  Â  Â  Â  startTime: startTime,
Â  Â  Â  Â  Â  Â  Â  Â  endTime: endTime,
Â  Â  Â  Â  Â  Â  Â  Â  completionDate: null
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  // Create the UI element
Â  Â  Â  Â  Â  Â  const newTaskElement = createTaskElement(newTaskData, 'todo');
Â  Â  Â  Â  Â  Â  const todoColumn = document.getElementById('todo');
Â  Â  Â  Â  Â  Â  const todoTasksContainer = todoColumn?.querySelector('.tasks-container');

Â  Â  Â  Â  Â  Â  if (newTaskElement && todoTasksContainer) {
Â  Â  Â  Â  Â  Â  Â  Â  // Add the new task to the 'To Do' column
Â  Â  Â  Â  Â  Â  Â  Â  todoTasksContainer.appendChild(newTaskElement);
Â  Â  Â  Â  Â  Â  Â  Â  // Save the updated board state
Â  Â  Â  Â  Â  Â  Â  Â  await saveCurrentBoardState();
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Scheduled idea task "${newTaskData.text}" for ${currentSelectedDate}`);

Â  Â  Â  Â  Â  Â  Â  Â  // --- Delete the original idea task from Firestore and UI ---
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`DEBUG: Deleting original idea task (ID: ${ideaTaskToSchedule.id}) after scheduling.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await deleteIdeaTaskFromFirestore(ideaTaskToSchedule.id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const originalIdeaElement = document.getElementById(`idea-${ideaTaskToSchedule.id}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (originalIdeaElement) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  originalIdeaElement.remove();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`DEBUG: Removed original idea task element from UI.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`DEBUG: Could not find original idea task element (ID: idea-${ideaTaskToSchedule.id}) to remove from UI.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error(`Error deleting original idea task (ID: ${ideaTaskToSchedule.id}) after scheduling:`, error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Inform user, but the main scheduling likely succeeded
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(`Task scheduled, but failed to remove the original from the Idea Box. Please remove it manually.`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // --- End Deletion ---

Â  Â  Â  Â  Â  Â  Â  Â  hideTimePrompt(); // Close the modal
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error creating or appending scheduled task element.");
Â  Â  Â  Â  Â  Â  Â  Â  alert("Error adding scheduled task to the board.");
Â  Â  Â  Â  Â  Â  Â  Â  hideTimePrompt();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- Other Core Functions ---

Â  Â  Â  Â  // Triggers a confetti burst effect
Â  Â  Â  Â  function triggerConfetti() {
Â  Â  Â  Â  Â  Â  if (!myConfetti) return; // Ensure confetti is initialized
Â  Â  Â  Â  Â  Â  myConfetti({
Â  Â  Â  Â  Â  Â  Â  Â  particleCount: 200, // Number of confetti particles
Â  Â  Â  Â  Â  Â  Â  Â  spread: 100, // How wide the confetti spreads
Â  Â  Â  Â  Â  Â  Â  Â  origin: { y: 0.6 }, // Starting position (0.6 means 60% down the screen)
Â  Â  Â  Â  Â  Â  Â  Â  colors: ['#f97316', '#ef4444', '#facc15', '#ffffff', '#a855f7'] // Custom colors
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // Archives a completed task to the 'hustle_archive' collection
Â  Â  Â  Â  async function archiveTaskToFirestore(taskData) {
Â  Â  Â  Â  Â  Â  if (!db || !hustleArchiveCollection) { console.error("Firestore 'hustle_archive' collection not initialized."); return; }
Â  Â  Â  Â  Â  Â  // Ensure task has necessary data for archiving
Â  Â  Â  Â  Â  Â  if (!taskData.completionDate || !taskData.text) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Skipping archive for task missing completion date or text:", taskData);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Add an 'archivedAt' timestamp
Â  Â  Â  Â  Â  Â  const archiveData = {
Â  Â  Â  Â  Â  Â  Â  Â  ...taskData,
Â  Â  Â  Â  Â  Â  Â  Â  archivedAt: firebase.firestore.FieldValue.serverTimestamp()
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await hustleArchiveCollection.add(archiveData); // Add to archive collection
Â  Â  Â  Â  Â  Â  Â  Â  console.log("Task archived to Firestore:", taskData.text);
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error archiving task to Firestore:", error);
Â  Â  Â  Â  Â  Â  Â  Â  // Consider if user notification is needed here
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Processes past dates, moves completed tasks to archive, and cleans up old documents
Â  Â  Â  Â  async function runArchivingProcess() {
Â  Â  Â  Â  Â  Â  if (!db || !hustleTasksCollection || !hustleArchiveCollection) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Firestore not initialized. Skipping archiving.");
Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const todayDateStr = getCurrentDateString(BOSTON_TIMEZONE);
Â  Â  Â  Â  Â  Â  let tasksArchived = false;
Â  Â  Â  Â  Â  Â  console.log("Running archiving process...");

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Query for documents in 'hustle_tasks' with IDs (dates) less than today's date
Â  Â  Â  Â  Â  Â  Â  Â  const querySnapshot = await hustleTasksCollection.where(firebase.firestore.FieldPath.documentId(), "<", todayDateStr).get();

Â  Â  Â  Â  Â  Â  Â  Â  if (querySnapshot.empty) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("No past dates found with tasks to archive.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return false; // Nothing to do
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const batch = db.batch(); // Use a batch for efficient updates/deletes
Â  Â  Â  Â  Â  Â  Â  Â  const archivePromises = []; // To track individual archive additions

Â  Â  Â  Â  Â  Â  Â  Â  querySnapshot.forEach(doc => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dateString = doc.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tasksForDay = doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let dayWasModified = false; // Flag if changes are made to this day's doc

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Process 'done' tasks for this past date
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (tasksForDay.done && Array.isArray(tasksForDay.done) && tasksForDay.done.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tasksToKeepInDone = []; // Tasks that might remain (e.g., if missing completion date)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tasksToArchive = []; Â  Â // Tasks to move to the archive collection

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tasksForDay.done.forEach(taskData => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Only archive tasks that have a completion date
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (taskData.completionDate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tasksToArchive.push(taskData);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tasksArchived = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dayWasModified = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Keep tasks without a completion date in the 'done' list (shouldn't happen ideally)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tasksToKeepInDone.push(taskData);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`Task in 'done' column for ${dateString} lacks completion date:`, taskData.text);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // If tasks were marked for archiving, update the original document
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (dayWasModified) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Add individual archive operations (these happen outside the batch)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tasksToArchive.forEach(taskData => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  archivePromises.push(archiveTaskToFirestore(taskData));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Update the original date document in the batch to remove the archived tasks
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const docRef = hustleTasksCollection.doc(dateString);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  batch.update(docRef, { done: tasksToKeepInDone });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Marked document ${dateString} for update in batch (removing archived tasks).`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Optional: Check if 'todo' and 'inprogress' are also empty after processing 'done'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // If all lists are empty, you could potentially delete the entire date document using batch.delete(docRef)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Example:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // if (dayWasModified && tasksToKeepInDone.length === 0 && (!tasksForDay.todo || tasksForDay.todo.length === 0) && (!tasksForDay.inprogress || tasksForDay.inprogress.length === 0)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Â  Â  console.log(`Marking empty document ${dateString} for deletion in batch.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Â  Â  batch.delete(hustleTasksCollection.doc(dateString));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  // Commit all batched writes/updates/deletes
Â  Â  Â  Â  Â  Â  Â  Â  await batch.commit();
Â  Â  Â  Â  Â  Â  Â  Â  console.log("Batch update/delete committed successfully.");
Â  Â  Â  Â  Â  Â  Â  Â  // Wait for all individual archive additions to settle
Â  Â  Â  Â  Â  Â  Â  Â  await Promise.allSettled(archivePromises);
Â  Â  Â  Â  Â  Â  Â  Â  console.log("Individual archive operations settled.");

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error during archiving process query or batch commit:", error);
Â  Â  Â  Â  Â  Â  Â  Â  // Handle potential errors during the batch commit or query
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  console.log(`Archiving process finished. Tasks archived: ${tasksArchived}`);
Â  Â  Â  Â  Â  Â  return tasksArchived;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Generates the summary text for the previous day's completed tasks
Â  Â  Â  Â  function generateSummaryText(tasks) {
Â  Â  Â  Â  Â  Â  let taskSummary;
Â  Â  Â  Â  Â  Â  if (!tasks || tasks.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  taskSummary = "Looks like there were no completed tasks logged for the previous day.";
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const taskTexts = tasks.map(t => t.text || 'Unnamed Task');
Â  Â  Â  Â  Â  Â  Â  Â  taskSummary = `Yesterday, you crushed ${tasks.length} task(s): `;
Â  Â  Â  Â  Â  Â  Â  Â  // Format the list nicely
Â  Â  Â  Â  Â  Â  Â  Â  if (taskTexts.length === 1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  taskSummary += `<strong>${taskTexts[0]}</strong>.`;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (taskTexts.length === 2) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  taskSummary += `<strong>${taskTexts[0]}</strong> and <strong>${taskTexts[1]}</strong>.`;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const lastTask = taskTexts.pop();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  taskSummary += `<strong>${taskTexts.join('</strong>, <strong>')}</strong>, and <strong>${lastTask}</strong>.`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Add a random motivational suffix
Â  Â  Â  Â  Â  Â  if (motivationalSuffixes.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  currentSuffixIndex = (currentSuffixIndex + 1) % motivationalSuffixes.length;
Â  Â  Â  Â  Â  Â  Â  Â  taskSummary += `<span class="motivation-suffix">${motivationalSuffixes[currentSuffixIndex]}</span>`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  taskSummary += `<span class="motivation-suffix">Keep up the great work!</span>`; // Fallback
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return taskSummary;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Fetches archived tasks for yesterday and displays the summary
Â  Â  Â  Â  async function displayLatestSummary() {
Â  Â  Â  Â  Â  Â  if (!db || !hustleArchiveCollection) { console.error("Firestore 'hustle_archive' collection not initialized."); dailySummaryDiv.classList.add('hidden'); return; }
Â  Â  Â  Â  Â  Â  console.log("Fetching previous day's summary...");

Â  Â  Â  Â  Â  Â  // Calculate yesterday's date string
Â  Â  Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  Â  Â  const yesterday = new Date(today);
Â  Â  Â  Â  Â  Â  yesterday.setDate(today.getDate() - 1);
Â  Â  Â  Â  Â  Â  const yesterdayDateStr = new Intl.DateTimeFormat('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: BOSTON_TIMEZONE }).format(yesterday);

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Query the archive collection for tasks completed yesterday
Â  Â  Â  Â  Â  Â  Â  Â  const querySnapshot = await hustleArchiveCollection.where("completionDate", "==", yesterdayDateStr).get();
Â  Â  Â  Â  Â  Â  Â  Â  const tasksForYesterday = [];
Â  Â  Â  Â  Â  Â  Â  Â  querySnapshot.forEach(doc => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tasksForYesterday.push(doc.data());
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  // Generate and display the summary text
Â  Â  Â  Â  Â  Â  Â  Â  summaryContentP.innerHTML = generateSummaryText(tasksForYesterday);
Â  Â  Â  Â  Â  Â  Â  Â  const summaryTitle = dailySummaryDiv.querySelector('h3');
Â  Â  Â  Â  Â  Â  Â  Â  if (summaryTitle) summaryTitle.textContent = `Daily Wins Recap for ${formatDisplayDate(yesterdayDateStr)}!`;
Â  Â  Â  Â  Â  Â  Â  Â  dailySummaryDiv.classList.remove('hidden'); // Show the summary section
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Displaying summary for ${yesterdayDateStr} with ${tasksForYesterday.length} tasks.`);
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error fetching archived tasks for summary:", error);
Â  Â  Â  Â  Â  Â  Â  Â  summaryContentP.innerHTML = "Could not load previous day's summary.";
Â  Â  Â  Â  Â  Â  Â  Â  const summaryTitle = dailySummaryDiv.querySelector('h3');
Â  Â  Â  Â  Â  Â  Â  Â  if (summaryTitle) summaryTitle.textContent = `Daily Wins Recap`;
Â  Â  Â  Â  Â  Â  Â  Â  dailySummaryDiv.classList.remove('hidden'); // Still show the section, but with error text
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Checks tasks in 'To Do' column and moves them to 'In Progress' if their start time has passed
Â  Â  Â  Â  async function checkAndMoveTasks() {
Â  Â  Â  Â  Â  Â  if (!db) return; // Ensure DB is initialized
Â  Â  Â  Â  Â  Â  const todayDateStr = getCurrentDateString(BOSTON_TIMEZONE);
Â  Â  Â  Â  Â  Â  // Only run this check if the currently viewed date is today
Â  Â  Â  Â  Â  Â  if (currentSelectedDate !== todayDateStr) {
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const currentTimeStr = getCurrentTimeString(BOSTON_TIMEZONE);

Â  Â  Â  Â  Â  Â  // Get column elements
Â  Â  Â  Â  Â  Â  const todoCol = document.getElementById('todo');
Â  Â  Â  Â  Â  Â  const inProgressCol = document.getElementById('inprogress');
Â  Â  Â  Â  Â  Â  if (!todoCol || !inProgressCol) { console.error("Cannot find columns for auto-move."); return; }
Â  Â  Â  Â  Â  Â  const todoTasksContainer = todoCol.querySelector('.tasks-container');
Â  Â  Â  Â  Â  Â  const inProgressTasksContainer = inProgressCol.querySelector('.tasks-container');
Â  Â  Â  Â  Â  Â  if (!todoTasksContainer || !inProgressTasksContainer) { console.error("Cannot find task containers for auto-move."); return; }

Â  Â  Â  Â  Â  Â  const tasksInTodo = todoTasksContainer.querySelectorAll('.kanban-task');
Â  Â  Â  Â  Â  Â  let taskMoved = false; // Flag to check if any task was moved

Â  Â  Â  Â  Â  Â  tasksInTodo.forEach(task => {
Â  Â  Â  Â  Â  Â  Â  Â  if (task.classList.contains('editing')) { return; } // Skip tasks being edited
Â  Â  Â  Â  Â  Â  Â  Â  const taskStartTime = task.dataset.startTime;
Â  Â  Â  Â  Â  Â  Â  Â  // If task has a start time and the current time is past it
Â  Â  Â  Â  Â  Â  Â  Â  if (taskStartTime && currentTimeStr >= taskStartTime) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Auto-moving task "${task.dataset.text}" (ID: ${task.id}) to In Progress`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Add progress elements if not already present
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (task.dataset.startTime && task.dataset.endTime && !task.querySelector('.task-progress-container')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  task.appendChild(createProgressElements());
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Move the task element to the 'In Progress' container
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  inProgressTasksContainer.appendChild(task);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  taskMoved = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Add a temporary highlight class
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  task.classList.add('task-just-moved');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  task.classList.remove('task-just-moved');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 1800); // Remove highlight after 1.8 seconds
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // If any task was moved, save the board state and update timers
Â  Â  Â  Â  Â  Â  if (taskMoved) {
Â  Â  Â  Â  Â  Â  Â  Â  await saveCurrentBoardState();
Â  Â  Â  Â  Â  Â  Â  Â  updateInProgressTimers();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Displays a random motivational quote
Â  Â  Â  Â  function displayMotivationalQuote() {
Â  Â  Â  Â  Â  Â  if (!quoteDisplay || motivationalQuotes.length === 0) return;
Â  Â  Â  Â  Â  Â  let randomIndex;
Â  Â  Â  Â  Â  Â  // Ensure the new quote is different from the last one shown, if possible
Â  Â  Â  Â  Â  Â  if (motivationalQuotes.length > 1) {
Â  Â  Â  Â  Â  Â  Â  Â  do {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  randomIndex = Math.floor(Math.random() * motivationalQuotes.length);
Â  Â  Â  Â  Â  Â  Â  Â  } while (randomIndex === currentQuoteIndex);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  randomIndex = 0; // Only one quote available
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  currentQuoteIndex = randomIndex; // Update the index
Â  Â  Â  Â  Â  Â  quoteDisplay.textContent = motivationalQuotes[currentQuoteIndex]; // Set the text content
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- In Progress Timer Update Functions ---

Â  Â  Â  Â  // Updates the progress bar and remaining time for a single task
Â  Â  Â  Â  function updateSingleTaskTimer(taskElement) {
Â  Â  Â  Â  Â  Â  const progressBarFill = taskElement.querySelector('.progress-bar-fill');
Â  Â  Â  Â  Â  Â  const remainingTimeSpan = taskElement.querySelector('.remaining-time');
Â  Â  Â  Â  Â  Â  const startTimeStr = taskElement.dataset.startTime;
Â  Â  Â  Â  Â  Â  const endTimeStr = taskElement.dataset.endTime;

Â  Â  Â  Â  Â  Â  // Ensure necessary elements and data are present
Â  Â  Â  Â  Â  Â  if (!progressBarFill || !remainingTimeSpan || !startTimeStr || !endTimeStr) {
Â  Â  Â  Â  Â  Â  Â  Â  return Infinity; // Return a large number if data is missing
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  Â  Â  // Create Date objects using the currently selected date and the task times
Â  Â  Â  Â  Â  Â  Â  Â  const startDate = new Date(`${currentSelectedDate}T${startTimeStr}:00`);
Â  Â  Â  Â  Â  Â  Â  Â  const endDate = new Date(`${currentSelectedDate}T${endTimeStr}:00`);

Â  Â  Â  Â  Â  Â  Â  Â  // Validate dates
Â  Â  Â  Â  Â  Â  Â  Â  if (isNaN(startDate) || isNaN(endDate) || endDate <= startDate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  remainingTimeSpan.textContent = 'Invalid Time';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  progressBarFill.style.width = '0%';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return Infinity;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Calculate durations and percentage
Â  Â  Â  Â  Â  Â  Â  Â  const totalDurationMillis = endDate - startDate;
Â  Â  Â  Â  Â  Â  Â  Â  const elapsedMillis = now - startDate;
Â  Â  Â  Â  Â  Â  Â  Â  const remainingMillis = endDate - now;
Â  Â  Â  Â  Â  Â  Â  Â  let percentage = (elapsedMillis / totalDurationMillis) * 100;
Â  Â  Â  Â  Â  Â  Â  Â  percentage = Math.max(0, Math.min(100, percentage)); // Clamp between 0 and 100

Â  Â  Â  Â  Â  Â  Â  Â  // Update progress bar width
Â  Â  Â  Â  Â  Â  Â  Â  progressBarFill.style.width = `${percentage}%`;

Â  Â  Â  Â  Â  Â  Â  Â  // Update remaining time text
Â  Â  Â  Â  Â  Â  Â  Â  const remainingSecondsTotal = Math.round(remainingMillis / 1000);
Â  Â  Â  Â  Â  Â  Â  Â  remainingTimeSpan.classList.toggle('expired', remainingSecondsTotal < 0); // Add 'expired' class if time is up

Â  Â  Â  Â  Â  Â  Â  Â  if (remainingSecondsTotal < 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  remainingTimeSpan.textContent = 'Time Up!';
Â  Â  Â  Â  Â  Â  Â  Â  } else if (remainingSecondsTotal < 60) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Display seconds if less than a minute remains
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  remainingTimeSpan.textContent = `${remainingSecondsTotal}s left`;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Display minutes otherwise
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const remainingMinutes = Math.ceil(remainingSecondsTotal / 60);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  remainingTimeSpan.textContent = `${remainingMinutes}m left`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return remainingSecondsTotal; // Return remaining seconds for interval adjustment

Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error updating timer for task:", taskElement.id, e);
Â  Â  Â  Â  Â  Â  Â  Â  remainingTimeSpan.textContent = 'Error';
Â  Â  Â  Â  Â  Â  Â  Â  progressBarFill.style.width = '0%';
Â  Â  Â  Â  Â  Â  Â  Â  return Infinity; // Return large number on error
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Updates timers for all tasks currently in the 'In Progress' column
Â  Â  Â  Â  function updateInProgressTimers() {
Â  Â  Â  Â  Â  Â  const inProgressColumn = document.getElementById('inprogress');
Â  Â  Â  Â  Â  Â  const tasksContainer = inProgressColumn?.querySelector('.tasks-container');
Â  Â  Â  Â  Â  Â  if (!tasksContainer) return; // Exit if container not found

Â  Â  Â  Â  Â  Â  const tasks = tasksContainer.querySelectorAll('.kanban-task');
Â  Â  Â  Â  Â  Â  let isInLastMinute = false; // Flag if any task has < 60s remaining

Â  Â  Â  Â  Â  Â  tasks.forEach(task => {
Â  Â  Â  Â  Â  Â  Â  Â  Â // Ensure progress elements exist if task should have them
Â  Â  Â  Â  Â  Â  Â  Â  Â if (task.dataset.startTime && task.dataset.endTime && !task.querySelector('.task-progress-container')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  task.appendChild(createProgressElements());
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â // Update the timer for this task
Â  Â  Â  Â  Â  Â  Â  Â  Â const remainingSeconds = updateSingleTaskTimer(task);
Â  Â  Â  Â  Â  Â  Â  Â  Â // Check if this task triggers the need for faster updates
Â  Â  Â  Â  Â  Â  Â  Â  Â if (remainingSeconds >= 0 && remainingSeconds < 60) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isInLastMinute = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // Adjust update interval based on whether any task is in its last minute
Â  Â  Â  Â  Â  Â  if (isInLastMinute && !lastMinuteIntervalId) {
Â  Â  Â  Â  Â  Â  Â  Â  // Switch to faster (1-second) updates
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(progressTimerIntervalId); // Clear the slower interval
Â  Â  Â  Â  Â  Â  Â  Â  progressTimerIntervalId = null;
Â  Â  Â  Â  Â  Â  Â  Â  lastMinuteIntervalId = setInterval(updateInProgressTimers, LAST_MINUTE_INTERVAL);
Â  Â  Â  Â  Â  Â  Â  Â  console.log("Starting last minute timer interval (1s).");
Â  Â  Â  Â  Â  Â  } else if (!isInLastMinute && lastMinuteIntervalId) {
Â  Â  Â  Â  Â  Â  Â  Â  // Switch back to slower updates if no tasks are in the last minute
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(lastMinuteIntervalId); // Clear the faster interval
Â  Â  Â  Â  Â  Â  Â  Â  lastMinuteIntervalId = null;
Â  Â  Â  Â  Â  Â  Â  Â  // Restart the regular interval only if it's not already running
Â  Â  Â  Â  Â  Â  Â  Â  if (!progressTimerIntervalId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  progressTimerIntervalId = setInterval(updateInProgressTimers, TIMER_UPDATE_INTERVAL);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Stopping last minute timer, restarting regular interval (15s).");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Initialization ---
Â  Â  Â  Â  // Runs when the DOM content is fully loaded
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', async () => {
Â  Â  Â  Â  Â  Â  console.log("DOM fully loaded and parsed.");

Â  Â  Â  Â  Â  Â  // Initial setup for time display and quote
Â  Â  Â  Â  Â  Â  updateTimeDisplay();
Â  Â  Â  Â  Â  Â  setInterval(updateTimeDisplay, 60000); // Update time every minute
Â  Â  Â  Â  Â  Â  displayMotivationalQuote();

Â  Â  Â  Â  Â  Â  // --- Crucial Check: Ensure Firebase initialized ---
Â  Â  Â  Â  Â  Â  if (!db) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("DB not initialized. Aborting further setup.");
Â  Â  Â  Â  Â  Â  Â  Â  // Display error message prominently if DB connection failed earlier
Â  Â  Â  Â  Â  Â  Â  Â  if(selectedDateDisplay) selectedDateDisplay.textContent = "Database Connection Failed! Check Config.";
Â  Â  Â  Â  Â  Â  Â  Â  // Disable interaction if DB failed
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('button, input').forEach(el => el.disabled = true);
Â  Â  Â  Â  Â  Â  Â  Â  return; // Stop initialization
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // --- End DB Check ---

Â  Â  Â  Â  Â  Â  console.log("Database connection available. Proceeding...");

Â  Â  Â  Â  Â  Â  // Run the archiving process for past dates on load
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â await runArchivingProcess();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Error during initial archiving:", error);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Load Idea Box tasks first
Â  Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â  Â await displayIdeaTasks();
Â  Â  Â  Â  Â  Â  Â } catch(error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â // Error is logged within loadIdeaTasksFromFirestore now
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Failed initial idea task load (caught in DOMContentLoaded):", error);
Â  Â  Â  Â  Â  Â  Â }


Â  Â  Â  Â  Â  Â  // Load tasks for the current date
Â  Â  Â  Â  Â  Â  const currentBostonDate = getCurrentDateString(BOSTON_TIMEZONE);
Â  Â  Â  Â  Â  Â  if (dateSelector) {
Â  Â  Â  Â  Â  Â  Â  Â  dateSelector.value = currentBostonDate; // Set date picker to today
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await displayTasksForDate(currentBostonDate); // Load today's tasks
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Error is logged within loadTasksFromFirestore and handled in displayTasksForDate
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Failed initial daily task load (caught in DOMContentLoaded):", error);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â // Add event listener for date changes *after* initial load attempt
Â  Â  Â  Â  Â  Â  Â  Â  dateSelector.addEventListener('change', (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayTasksForDate(event.target.value); // Load tasks for the newly selected date
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Fallback if date selector element isn't found (shouldn't happen)
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Date selector element not found.");
Â  Â  Â  Â  Â  Â  Â  Â  try { await displayTasksForDate(currentBostonDate); } catch (error) { /* Handled in displayTasksForDate */ }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Load and display the summary for yesterday
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â await displayLatestSummary();
Â  Â  Â  Â  Â  Â  } catch(error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Failed to display latest summary:", error);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- Add Event Listeners for Forms and Modals ---
Â  Â  Â  Â  Â  Â  const addTaskBtnLocal = document.getElementById('add-task-btn');
Â  Â  Â  Â  Â  Â  if (addTaskBtnLocal) {
Â  Â  Â  Â  Â  Â  Â  Â  addTaskBtnLocal.addEventListener('click', addTask);
Â  Â  Â  Â  Â  Â  Â  Â  // Allow adding daily tasks by pressing Enter in form fields
Â  Â  Â  Â  Â  Â  Â  Â  const dailyTaskInputs = ['new-task-input', 'new-task-start-time', 'new-task-end-time'];
Â  Â  Â  Â  Â  Â  Â  Â  dailyTaskInputs.forEach(id => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const input = document.getElementById(id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (input) input.addEventListener('keypress', (event) => { if (event.key === 'Enter') addTask(); });
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  } else { console.error("Add daily task button not found."); }

Â  Â  Â  Â  Â  Â  if (addIdeaTaskBtn && ideaTaskInput) {
Â  Â  Â  Â  Â  Â  Â  Â  addIdeaTaskBtn.addEventListener('click', addIdeaTask);
Â  Â  Â  Â  Â  Â  Â  Â  // Allow adding idea tasks by pressing Enter in the input field
Â  Â  Â  Â  Â  Â  Â  Â  ideaTaskInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') addIdeaTask(); });
Â  Â  Â  Â  Â  Â  } else { console.error("Add idea task button or input not found."); }

Â  Â  Â  Â  Â  Â  // Add listeners for modal buttons
Â  Â  Â  Â  Â  Â  if (modalSaveBtn) modalSaveBtn.addEventListener('click', handleModalSave);
Â  Â  Â  Â  Â  Â  if (modalCancelBtn) modalCancelBtn.addEventListener('click', hideTimePrompt);

Â  Â  Â  Â  Â  Â  // --- Start Background Intervals ---
Â  Â  Â  Â  Â  Â  // Start interval to check for tasks whose start time has passed
Â  Â  Â  Â  Â  Â  if (taskCheckIntervalId) clearInterval(taskCheckIntervalId); // Clear existing if any
Â  Â  Â  Â  Â  Â  taskCheckIntervalId = setInterval(checkAndMoveTasks, TASK_CHECK_INTERVAL);
Â  Â  Â  Â  Â  Â  console.log(`Started task check interval (${TASK_CHECK_INTERVAL / 1000}s). ID: ${taskCheckIntervalId}`);

Â  Â  Â  Â  Â  Â  // Start interval to update progress timers for 'In Progress' tasks
Â  Â  Â  Â  Â  Â  if (progressTimerIntervalId) clearInterval(progressTimerIntervalId); // Clear existing if any
Â  Â  Â  Â  Â  Â  if (lastMinuteIntervalId) clearInterval(lastMinuteIntervalId); // Clear existing if any
Â  Â  Â  Â  Â  Â  progressTimerIntervalId = setInterval(updateInProgressTimers, TIMER_UPDATE_INTERVAL);
Â  Â  Â  Â  Â  Â  console.log(`Started progress timer interval (${TIMER_UPDATE_INTERVAL / 1000}s). ID: ${progressTimerIntervalId}`);

Â  Â  Â  Â  Â  Â  console.log("Initialization complete.");
Â  Â  Â  Â  });
Â  Â  </script>

</body>
</html>
